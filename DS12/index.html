<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS12 - æ·±æ¸Šæ‰«é›·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .game-title {
            color: #e94560;
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .game-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .game-info {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .info-item {
            background: #1a1a2e;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #2a2a3a;
        }
        
        .info-label {
            color: #666;
            font-size: 12px;
        }
        
        .info-value {
            color: #e94560;
            font-size: 18px;
            font-weight: bold;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(16, 30px);
            grid-template-rows: repeat(16, 30px);
            gap: 2px;
            background: #0f0f1a;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #2a2a3a;
            user-select: none;
        }
        
        .cell {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        /* æœªæ­ç¤º */
        .cell.hidden {
            background: #2a2a3a;
            border: 2px solid #3a3a4a;
        }
        
        .cell.hidden:hover {
            background: #3a3a4a;
            border-color: #e94560;
        }
        
        /* å·²æ­ç¤ºå®‰å…¨æ ¼ */
        .cell.revealed {
            background: #1a1a2e;
            border: 1px solid #2a2a3a;
            color: #27ae60;
        }
        
        /* æ•°å­—é¢œè‰² */
        .cell.num-1 { color: #3498db; }
        .cell.num-2 { color: #27ae60; }
        .cell.num-3 { color: #e74c3c; }
        .cell.num-4 { color: #9b59b6; }
        .cell.num-5 { color: #f39c12; }
        .cell.num-6 { color: #1abc9c; }
        .cell.num-7 { color: #34495e; }
        .cell.num-8 { color: #7f8c8d; }
        
        /* é›·æ ¼ï¼ˆè¸©ä¸­åæ˜¾ç¤ºï¼‰ */
        .cell.mine {
            background: #3a1a1e;
            border: 2px solid #e94560;
            color: #e94560;
        }
        
        /* æ ‡è®° */
        .cell.marked {
            background: #3a3a1e;
            border: 2px solid #f39c12;
            color: #f39c12;
        }
        
        .cell.marked::after {
            content: 'ğŸš©';
            font-size: 12px;
        }
        
        /* æ ¸å¿ƒï¼ˆæ‰¾åˆ°åæ˜¾ç¤ºï¼‰ */
        .cell.core {
            background: #2a2a1e;
            border: 2px solid #f39c12;
            color: #f39c12;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #f39c12; }
            50% { box-shadow: 0 0 15px #f39c12; }
        }
        
        /* æ±¡æŸ“æ ¼ */
        .cell.polluted {
            position: relative;
        }
        
        .cell.polluted::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #9b59b6;
            border-radius: 4px;
            opacity: 0.6;
            pointer-events: none;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #1a1a2e;
            border: 2px solid #2a2a3a;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 6px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .btn:hover {
            border-color: #e94560;
            background: #2a1a2e;
        }
        
        .btn.primary {
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .btn.primary:hover {
            background: #1a3a2e;
        }
        
        .log-panel {
            width: 100%;
            max-width: 600px;
            height: 120px;
            background: #0f0f1a;
            border: 2px solid #2a2a3a;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 3px 0;
            border-left: 2px solid #3a3a4a;
            padding-left: 8px;
            margin-bottom: 3px;
            color: #888;
        }
        
        .log-entry.event { border-left-color: #e94560; color: #e94560; }
        .log-entry.reward { border-left-color: #27ae60; color: #27ae60; }
        .log-entry.warning { border-left-color: #f39c12; color: #f39c12; }
        .log-entry.info { border-left-color: #3498db; color: #3498db; }
        
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .game-over-overlay.show {
            display: flex;
        }
        
        .game-over-title {
            color: #e94560;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .game-over-reason {
            color: #888;
            margin-bottom: 20px;
        }
        
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            max-width: 600px;
            font-size: 12px;
            color: #888;
            line-height: 1.6;
        }
        
        .instructions strong {
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="game-title">DS12 - æ·±æ¸Šæ‰«é›·</div>
    <div class="game-subtitle">åŸç‰ˆæ‰«é›· + F3/F4 æœºåˆ¶</div>
    
    <div class="game-info">
        <div class="info-item">
            <div class="info-label">å‰©ä½™é›·æ•°</div>
            <div class="info-value" id="mineCount">40</div>
        </div>
        <div class="info-item">
            <div class="info-label">å°è®°</div>
            <div class="info-value" id="markCount">0/3</div>
        </div>
        <div class="info-item">
            <div class="info-label">æ ¸å¿ƒ</div>
            <div class="info-value" id="coreStatus">æœªæ‰¾åˆ°</div>
        </div>
    </div>
    
    <div class="grid-container" id="gridContainer"></div>
    
    <div class="controls">
        <button class="btn" onclick="game.restart()">é‡æ–°å¼€å§‹</button>
        <button class="btn primary" onclick="game.retreat()">æ’¤é€€</button>
    </div>
    
    <div class="log-panel" id="logPanel"></div>
    
    <div class="instructions">
        <strong>æ“ä½œè¯´æ˜ï¼š</strong><br>
        â€¢ å·¦é”®ç‚¹å‡»ï¼šæ­ç¤ºæ ¼å­<br>
        â€¢ å³é”®ç‚¹å‡»ï¼šæ ‡è®°/å–æ¶ˆæ ‡è®°é›·<br>
        â€¢ æ•°å­—ï¼šå‘¨å›´8æ ¼é›·æ•°<br>
        â€¢ 0æ ¼ï¼šè‡ªåŠ¨è¿é”æ­ç¤ºå‘¨å›´<br>
        â€¢ è¸©é›·ï¼šè§¦å‘F3æ·±æ¸Šä¾µèš€ï¼ˆä¸ç»“æŸæ¸¸æˆï¼‰
    </div>
    
    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-title">æ¸¸æˆç»“æŸ</div>
        <div class="game-over-reason" id="gameOverReason"></div>
        <button class="btn" onclick="game.restart()">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        class DeepSweeper {
            constructor() {
                this.rows = 16;
                this.cols = 16;
                this.mineCount = 40;
                this.grid = [];
                this.revealed = [];
                this.marked = [];
                this.polluted = []; // æ±¡æŸ“æ ¼
                this.marks = 0; // å°è®°
                this.coreFound = false;
                this.gameOver = false;
                this.gameWon = false;
                this.init();
            }
            
            init() {
                this.createGrid();
                this.placeMines();
                this.calculateNumbers();
                this.placeCore();
                this.render();
                this.log('æ¸¸æˆå¼€å§‹ï¼å·¦é”®æ­ç¤ºï¼Œå³é”®æ ‡è®°ã€‚æ‰¾åˆ°æ ¸å¿ƒåå¯ä»¥é€‰æ‹©æ’¤é€€ã€‚', 'info');
            }
            
            createGrid() {
                this.grid = [];
                this.revealed = [];
                this.marked = [];
                this.polluted = [];
                this.marks = 0;
                this.coreFound = false;
                this.gameOver = false;
                this.gameWon = false;
                
                for (let y = 0; y < this.rows; y++) {
                    this.grid[y] = [];
                    this.revealed[y] = [];
                    this.marked[y] = [];
                    this.polluted[y] = [];
                    for (let x = 0; x < this.cols; x++) {
                        this.grid[y][x] = {
                            x, y,
                            isMine: false,
                            number: 0,
                            hasCore: false
                        };
                        this.revealed[y][x] = false;
                        this.marked[y][x] = false;
                        this.polluted[y][x] = false;
                    }
                }
            }
            
            placeMines() {
                let placed = 0;
                while (placed < this.mineCount) {
                    const x = Math.floor(Math.random() * this.cols);
                    const y = Math.floor(Math.random() * this.rows);
                    if (!this.grid[y][x].isMine) {
                        this.grid[y][x].isMine = true;
                        placed++;
                    }
                }
            }
            
            calculateNumbers() {
                for (let y = 0; y < this.rows; y++) {
                    for (let x = 0; x < this.cols; x++) {
                        if (this.grid[y][x].isMine) continue;
                        this.grid[y][x].number = this.countAdjacentMines(x, y);
                    }
                }
            }
            
            countAdjacentMines(x, y) {
                let count = 0;
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = x + dx, ny = y + dy;
                        if (this.isValid(nx, ny) && this.grid[ny][nx].isMine) {
                            count++;
                        }
                    }
                }
                return count;
            }
            
            placeCore() {
                // åœ¨å®‰å…¨æ ¼ä¸­éšæœºé€‰ä¸€ä¸ªè—æ ¸å¿ƒ
                const safeCells = [];
                for (let y = 0; y < this.rows; y++) {
                    for (let x = 0; x < this.cols; x++) {
                        if (!this.grid[y][x].isMine && this.grid[y][x].number === 0) {
                            safeCells.push({x, y});
                        }
                    }
                }
                if (safeCells.length > 0) {
                    const pos = safeCells[Math.floor(Math.random() * safeCells.length)];
                    this.grid[pos.y][pos.x].hasCore = true;
                }
            }
            
            isValid(x, y) {
                return x >= 0 && x < this.cols && y >= 0 && y < this.rows;
            }
            
            reveal(x, y) {
                if (this.gameOver || this.gameWon) return;
                if (!this.isValid(x, y)) return;
                if (this.revealed[y][x] || this.marked[y][x]) return;
                
                const cell = this.grid[y][x];
                
                // è¸©é›· - è§¦å‘F3
                if (cell.isMine) {
                    this.triggerF3(x, y);
                    return;
                }
                
                // æ­ç¤ºæ ¼å­
                this.revealed[y][x] = true;
                
                // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°æ ¸å¿ƒ
                if (cell.hasCore) {
                    this.coreFound = true;
                    this.log('ğŸ’ æ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒï¼ç°åœ¨å¯ä»¥é€‰æ‹©æ’¤é€€', 'reward');
                    this.updateUI();
                }
                
                // 0æ ¼è¿é”
                if (cell.number === 0) {
                    this.chainReveal(x, y);
                }
                
                this.render();
                this.checkWin();
            }
            
            chainReveal(x, y) {
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = x + dx, ny = y + dy;
                        if (this.isValid(nx, ny) && !this.revealed[ny][nx] && !this.marked[ny][nx]) {
                            const cell = this.grid[ny][nx];
                            if (!cell.isMine) {
                                this.revealed[ny][nx] = true;
                                if (cell.hasCore) {
                                    this.coreFound = true;
                                    this.log('ğŸ’ æ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒï¼', 'reward');
                                }
                                if (cell.number === 0) {
                                    this.chainReveal(nx, ny);
                                }
                            }
                        }
                    }
                }
            }
            
            // F3è§¦å‘ - è¸©é›·åçš„æ·±æ¸Šä¾µèš€
            triggerF3(x, y) {
                this.log(`ğŸ’€ è¸©ä¸­é›·æ ¼ï¼è§¦å‘F3æ·±æ¸Šä¾µèš€...`, 'event');
                
                // æ˜¾ç¤ºè¸©ä¸­çš„é›·
                this.revealed[y][x] = true;
                this.render();
                
                // å°è®°+1
                this.marks++;
                this.log(`è·å¾—å°è®°+1 (${this.marks}/3)`, 'info');
                
                // æ£€æŸ¥ç•¸å˜
                if (this.marks >= 3) {
                    this.triggerMutation();
                }
                
                // æ±¡æŸ“2åœˆ
                this.polluteArea(x, y, 2);
                
                // å¼ºåˆ¶æ­ç¤º3æ ¼
                this.forceReveal(x, y);
                
                this.updateUI();
            }
            
            // æ±¡æŸ“åŒºåŸŸ
            polluteArea(x, y, radius) {
                let pollutedCount = 0;
                for (let dy = -radius; dy <= radius; dy++) {
                    for (let dx = -radius; dx <= radius; dx++) {
                        const nx = x + dx, ny = y + dy;
                        if (this.isValid(nx, ny) && !this.revealed[ny][nx] && !this.marked[ny][nx]) {
                            this.polluted[ny][nx] = true;
                            pollutedCount++;
                        }
                    }
                }
                this.log(`âš ï¸ æ·±æ¸Šæ±¡æŸ“æ‰©æ•£ï¼Œ${pollutedCount}æ ¼è¢«æ±¡æŸ“ï¼ˆæ•°å­—å¯èƒ½Â±1ï¼‰`, 'warning');
            }
            
            // å¼ºåˆ¶æ­ç¤º3æ ¼
            forceReveal(centerX, centerY) {
                const candidates = [];
                
                // æ”¶é›†2åœˆå†…æœªæ­ç¤ºä¸”æœªæ ‡è®°çš„æ ¼å­
                for (let dy = -2; dy <= 2; dy++) {
                    for (let dx = -2; dx <= 2; dx++) {
                        const nx = centerX + dx, ny = centerY + dy;
                        if (this.isValid(nx, ny) && !this.revealed[ny][nx] && !this.marked[ny][nx]) {
                            candidates.push({x: nx, y: ny});
                        }
                    }
                }
                
                // éšæœºé€‰3æ ¼
                const shuffled = candidates.sort(() => Math.random() - 0.5);
                const selected = shuffled.slice(0, 3);
                
                let revealCount = 0;
                selected.forEach(pos => {
                    const cell = this.grid[pos.y][pos.x];
                    this.revealed[pos.y][pos.x] = true;
                    revealCount++;
                    
                    if (cell.isMine) {
                        this.log(`âš¡ å¼ºåˆ¶æ­ç¤ºè§¦é›·ï¼å†æ¬¡æ±¡æŸ“ï¼`, 'event');
                        this.polluteArea(pos.x, pos.y, 2);
                    } else if (cell.hasCore) {
                        this.coreFound = true;
                        this.log('ğŸ’ å¼ºåˆ¶æ­ç¤ºå‘ç°æ ¸å¿ƒï¼', 'reward');
                    }
                });
                
                this.log(`å¼ºåˆ¶æ­ç¤ºå®Œæˆï¼å…±æ­ç¤º${revealCount}æ ¼`, 'info');
                this.render();
            }
            
            // è§¦å‘ç•¸å˜
            triggerMutation() {
                this.log('ğŸ‘ï¸ å°è®°ç´¯ç§¯è¾¾åˆ°3ï¼æ·±æ¸Šç•¸å˜é™ä¸´...', 'event');
                this.log('ã€æ•°å­—æ¨¡ç³Šã€‘æ‰€æœ‰æ•°å­—æ˜¾ç¤ºÂ±1è¯¯å·®', 'warning');
                // è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„è´Ÿé¢æ•ˆæœ
            }
            
            // è·å–æ˜¾ç¤ºæ•°å­—ï¼ˆè€ƒè™‘æ±¡æŸ“ï¼‰
            getDisplayNumber(x, y) {
                let num = this.grid[y][x].number;
                
                // æ±¡æŸ“æ•ˆæœï¼šÂ±1è¯¯å·®
                if (this.polluted[y][x] && this.marks >= 3) {
                    const error = Math.random() < 0.5 ? -1 : 1;
                    num = Math.max(0, Math.min(8, num + error));
                }
                
                return num;
            }
            
            toggleMark(x, y) {
                if (this.gameOver || this.gameWon) return;
                if (!this.isValid(x, y)) return;
                if (this.revealed[y][x]) return;
                
                this.marked[y][x] = !this.marked[y][x];
                this.render();
                this.updateUI();
            }
            
            retreat() {
                if (this.gameOver || this.gameWon) return;
                
                let msg = 'ç¡®å®šè¦æ’¤é€€å—ï¼Ÿ';
                if (this.coreFound) {
                    msg = 'âœ… å·²æ‰¾åˆ°æ ¸å¿ƒï¼æ’¤é€€å°†è·å¾—èƒœåˆ©ï¼\n\nç¡®å®šè¦æ’¤é€€å—ï¼Ÿ';
                } else {
                    msg = 'âš ï¸ æœªæ‰¾åˆ°æ ¸å¿ƒï¼æ’¤é€€å°†ç»“æŸæ¸¸æˆã€‚\n\nç¡®å®šè¦æ’¤é€€å—ï¼Ÿ';
                }
                
                if (confirm(msg)) {
                    this.gameWon = true;
                    const overlay = document.getElementById('gameOverOverlay');
                    const title = document.querySelector('.game-over-title');
                    const reason = document.getElementById('gameOverReason');
                    
                    if (this.coreFound) {
                        title.textContent = 'ğŸ‰ èƒœåˆ©ï¼';
                        title.style.color = '#27ae60';
                        reason.textContent = 'æˆåŠŸæ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒå¹¶æ’¤é€€ï¼';
                    } else {
                        title.textContent = 'æ¸¸æˆç»“æŸ';
                        title.style.color = '#e94560';
                        reason.textContent = 'æ’¤é€€æ—¶æœªæ‰¾åˆ°æ ¸å¿ƒ';
                    }
                    
                    overlay.classList.add('show');
                }
            }
            
            checkWin() {
                // åŸç‰ˆæ‰«é›·èƒœåˆ©ï¼šæ ‡è®°æ‰€æœ‰é›·
                // DS12ï¼šæ‰¾åˆ°æ ¸å¿ƒ + é€‰æ‹©æ’¤é€€
                // ä¸éœ€è¦è‡ªåŠ¨èƒœåˆ©
            }
            
            render() {
                const container = document.getElementById('gridContainer');
                container.innerHTML = '';
                
                for (let y = 0; y < this.rows; y++) {
                    for (let x = 0; x < this.cols; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        
                        if (this.marked[y][x]) {
                            cell.classList.add('marked');
                        } else if (this.revealed[y][x]) {
                            const gridCell = this.grid[y][x];
                            if (gridCell.isMine) {
                                cell.classList.add('mine');
                                cell.textContent = 'ğŸ’€';
                            } else if (gridCell.hasCore) {
                                cell.classList.add('core');
                                cell.textContent = 'ğŸ’';
                            } else {
                                cell.classList.add('revealed');
                                if (this.polluted[y][x]) {
                                    cell.classList.add('polluted');
                                }
                                const num = this.getDisplayNumber(x, y);
                                if (num > 0) {
                                    cell.textContent = num;
                                    cell.classList.add(`num-${num}`);
                                }
                            }
                        } else {
                            cell.classList.add('hidden');
                        }
                        
                        cell.onclick = () => this.reveal(x, y);
                        cell.oncontextmenu = (e) => {
                            e.preventDefault();
                            this.toggleMark(x, y);
                        };
                        
                        container.appendChild(cell);
                    }
                }
            }
            
            updateUI() {
                const remainingMines = this.mineCount - this.marked.flat().filter(m => m).length;
                document.getElementById('mineCount').textContent = remainingMines;
                document.getElementById('markCount').textContent = `${this.marks}/3`;
                document.getElementById('coreStatus').textContent = this.coreFound ? 'å·²æ‰¾åˆ°ï¼' : 'æœªæ‰¾åˆ°';
                document.getElementById('coreStatus').style.color = this.coreFound ? '#27ae60' : '#e94560';
            }
            
            log(message, type = 'info') {
                const panel = document.getElementById('logPanel');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                panel.appendChild(entry);
                panel.scrollTop = panel.scrollHeight;
            }
            
            restart() {
                document.getElementById('gameOverOverlay').classList.remove('show');
                document.getElementById('logPanel').innerHTML = '';
                this.init();
                this.updateUI();
            }
        }
        
        const game = new DeepSweeper();
    </script>
</body>
</html>
