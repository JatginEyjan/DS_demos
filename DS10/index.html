<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS10 v0.2 - æ·±æ¸Šç¼–å¹´å²</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a0f; color: #e0e0e0; font-family: 'Courier New', monospace; font-size: 14px; min-height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* çŠ¶æ€æ  */
        .team-status-bar { background: #1a1a2e; padding: 8px 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; border-bottom: 2px solid #0f0f1a; }
        .investigator-status { background: #0f0f1a; border: 2px solid #2a2a3a; border-radius: 6px; padding: 8px; }
        .inv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .inv-name { font-size: 12px; font-weight: bold; }
        .status-label { font-size: 10px; padding: 2px 6px; border-radius: 3px; }
        .status-label.calm { background: #27ae60; }
        .status-label.uneasy { background: #f39c12; color: #000; }
        .status-label.nervous { background: #e67e22; }
        .status-label.fearful { background: #e94560; }
        .bar-row { display: flex; align-items: center; gap: 6px; }
        .bar-label { font-size: 10px; color: #888; width: 24px; }
        .bar-container { flex: 1; height: 10px; background: #0a0a0f; border: 1px solid #2a2a3a; overflow: hidden; }
        .bar-fill { height: 100%; background: #e94560; }
        .bar-fill.sanity { background: #7c3aed; }
        .bar-value { font-size: 10px; color: #888; width: 40px; text-align: right; }
        
        /* æ¸¸æˆå¸ƒå±€ */
        .game-layout { display: flex; height: calc(100vh - 70px); }
        .main-panel { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 8px; overflow: hidden; }
        .scene-header { text-align: center; padding: 10px; background: #1a1a2e; border: 2px solid #2a2a3a; }
        .scene-title { color: #e94560; font-size: 16px; font-weight: bold; }
        .scene-subtitle { color: #666; font-size: 11px; margin-top: 4px; }
        .main-content { flex: 1; background: #0f0f1a; border: 3px solid #2a2a3a; overflow-y: auto; padding: 15px; }
        .log-panel { background: #0a0a0f; border: 2px solid #1a1a2e; padding: 8px; height: 100px; overflow-y: auto; font-size: 11px; }
        .log-entry { margin-bottom: 4px; padding: 3px 8px; border-left: 3px solid #3a3a4a; }
        .log-entry.system { border-left-color: #3498db; color: #5dade2; }
        
        /* èŒä¸šé€‰æ‹© */
        .profession-select { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .profession-title { color: #e94560; font-size: 20px; margin-bottom: 20px; text-align: center; }
        .profession-card { background: #1a1a2e; border: 3px solid #2a2a3a; padding: 16px; margin: 8px; width: 100%; max-width: 300px; cursor: pointer; }
        .profession-card.selected { border-color: #27ae60; box-shadow: 0 0 15px rgba(39,174,96,0.5); }
        .profession-name { color: #e94560; font-size: 16px; font-weight: bold; margin-bottom: 8px; }
        .profession-stats { font-size: 11px; color: #888; }
        .hint { color: #666; text-align: center; margin-top: 20px; }
        
        /* æˆ¿é—´æ ·å¼ */
        .room-container { max-width: 600px; margin: 0 auto; }
        .room-desc { color: #ccc; line-height: 1.8; margin-bottom: 20px; font-size: 14px; }
        .discoveries { background: #1a1a2e; border: 2px solid #3a3a4a; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .discoveries-title { color: #888; font-size: 12px; margin-bottom: 10px; }
        .discovery-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #0f0f1a; border: 1px solid #2a2a3a; margin-bottom: 8px; cursor: pointer; }
        .discovery-item:hover { border-color: #e94560; }
        .discovery-icon { font-size: 20px; }
        .discovery-name { font-size: 13px; }
        .room-choices { display: flex; flex-direction: column; gap: 10px; }
        .choice-btn { background: #1a1a2e; border: 2px solid #3a3a4a; color: #e0e0e0; padding: 15px; cursor: pointer; text-align: left; }
        .choice-btn:hover { border-color: #e94560; background: #2a1a2e; }
        .choice-title { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; }
        .choice-desc { font-size: 11px; color: #888; }
        
        /* v0.2 æƒ…å¢ƒç³»ç»Ÿ */
        .situation-panel { background: #1a1a2e; border: 2px solid #3a3a4a; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .situation-title { color: #e94560; font-size: 12px; margin-bottom: 10px; font-weight: bold; }
        .situation-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .situation-label { font-size: 11px; width: 50px; color: #888; }
        .situation-bar-fill { flex: 1; height: 12px; background: #0a0a0f; border: 1px solid #2a2a3a; overflow: hidden; border-radius: 2px; }
        .situation-fill { height: 100%; transition: width 0.3s; }
        .situation-fill.resolve { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .situation-fill.deterioration { background: linear-gradient(90deg, #e94560, #c0392b); }
        .action-points { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #2a2a3a; }
        .ap-label { font-size: 11px; color: #888; }
        .ap-dot { width: 12px; height: 12px; border-radius: 50%; background: #27ae60; border: 2px solid #1a3a2e; }
        .ap-dot.used { background: #2a2a3a; border-color: #3a3a4a; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .card-btn { background: #1a1a2e; border: 2px solid #3a3a4a; color: #e0e0e0; padding: 12px; cursor: pointer; text-align: center; border-radius: 6px; }
        .card-btn:hover:not(:disabled) { border-color: #e94560; transform: translateY(-2px); }
        .card-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .card-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .card-name { font-size: 13px; font-weight: bold; }
        .card-effect { font-size: 10px; color: #888; margin-top: 3px; }
        .narrative-text { background: #0f0f1a; border-left: 3px solid #e94560; padding: 12px; margin: 15px 0; color: #ccc; font-size: 13px; line-height: 1.6; }
        
        /* å¯¹è±¡ç³»ç»Ÿæ ·å¼ */
        .object-panel { background: #1a1a2e; border: 2px solid #3a3a4a; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .object-title { color: #e94560; font-size: 12px; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .object-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .object-item { 
            display: flex; align-items: center; gap: 6px; padding: 8px 12px; 
            background: #0f0f1a; border: 2px solid #2a2a3a; border-radius: 6px; 
            cursor: pointer; transition: all 0.2s;
        }
        .object-item:hover { border-color: #e94560; background: #1a1a2e; }
        .object-item.selected { border-color: #27ae60; background: #1a3a2e; }
        .object-item.type-filler { border-left-color: #666; }
        .object-item.type-key { border-left-color: #f39c12; }
        .object-item.type-story { border-left-color: #e94560; }
        .object-icon { font-size: 18px; }
        .object-name { font-size: 12px; }
        .object-type { font-size: 9px; color: #666; margin-left: 4px; }
        
        .action-panel { background: #0f0f1a; border: 2px solid #2a2a3a; border-radius: 6px; padding: 12px; }
        .action-title { color: #888; font-size: 11px; margin-bottom: 8px; }
        .action-list { display: flex; flex-direction: column; gap: 8px; }
        .action-btn { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: #1a1a2e; border: 2px solid #3a3a4a; 
            color: #e0e0e0; cursor: pointer; text-align: left; border-radius: 4px;
        }
        .action-btn:hover:not(:disabled) { border-color: #e94560; background: #2a1a2e; }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-info { display: flex; flex-direction: column; }
        .action-name { font-size: 13px; font-weight: bold; }
        .action-desc { font-size: 10px; color: #888; }
        .action-meta { display: flex; gap: 8px; font-size: 10px; }
        .action-cost { color: #f39c12; }
        .action-rate { color: #27ae60; }
        
        /* åˆ¤å®šåŠ¨ç”»æ ·å¼ */
        .roll-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; 
            z-index: 3000; flex-direction: column;
        }
        .roll-overlay.show { display: flex; }
        .roll-display { 
            font-size: 80px; font-weight: bold; color: #e94560; 
            font-family: 'Courier New', monospace; text-shadow: 0 0 20px rgba(233,69,96,0.5);
        }
        .roll-result { 
            margin-top: 20px; font-size: 24px; font-weight: bold; 
            padding: 10px 30px; border-radius: 4px;
        }
        .roll-result.fumble { background: #7c1a1a; color: #fff; }
        .roll-result.fail { background: #3a3a4a; color: #aaa; }
        .roll-result.success { background: #1a5a3a; color: #2ecc71; }
        .roll-result.crit { background: linear-gradient(90deg, #f1c40f, #e67e22); color: #000; }
        .roll-detail { margin-top: 15px; font-size: 14px; color: #888; }
        .roll-close { 
            margin-top: 30px; padding: 12px 30px; background: #e94560; 
            color: white; border: none; cursor: pointer; font-size: 14px;
        }
        
        /* ç»“æœåé¦ˆåŒºåŸŸ */
        .result-feedback { 
            background: #0f0f1a; border-left: 3px solid #3498db; 
            padding: 15px; margin: 10px 0; border-radius: 0 4px 4px 0;
        }
        .result-layer { margin-bottom: 8px; }
        .result-layer:last-child { margin-bottom: 0; }
        .layer-action { color: #888; font-size: 12px; }
        .layer-roll { color: #f39c12; font-size: 13px; font-weight: bold; }
        .layer-narrative { color: #ccc; font-size: 14px; line-height: 1.6; margin-top: 8px; padding-top: 8px; border-top: 1px solid #2a2a3a; }
        
        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: #1a1a2e; border: 4px solid #e94560; padding: 24px; max-width: 300px; text-align: center; }
        .modal-title { color: #e94560; font-size: 18px; margin-bottom: 12px; }
        .modal-text { color: #aaa; font-size: 13px; margin-bottom: 20px; }
        .modal-btn { background: #e94560; border: none; color: white; padding: 12px 24px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- èŒä¸šé€‰æ‹© -->
    <div id="professionSelect" class="profession-select">
        <h1 class="profession-title">DS10 v0.2 - æ·±æ¸Šç¼–å¹´å²<br><span style="font-size:14px;color:#666;">é€‰æ‹©2åè°ƒæŸ¥å‘˜ç»„æˆå°é˜Ÿ</span></h1>
        <div class="profession-card" id="card1" onclick="selectProf('archaeologist')">
            <div class="profession-name">ğŸ” è€ƒå¤å­¦å®¶</div>
            <div class="profession-stats">HP:70 SAN:100 | ä¾¦æŸ¥50 åŠ›é‡30 ç¥ç§˜å­¦35<br><span style="color:#27ae60;">ç²¾é€šå¤ä»£æ–‡çŒ®ï¼Œèƒ½ä»ç¬¦å·ä¸­å‘ç°éšè—ä¿¡æ¯</span></div>
        </div>
        <div class="profession-card" id="card2" onclick="selectProf('soldier')">
            <div class="profession-name">âš”ï¸ å‰å†›äºº</div>
            <div class="profession-stats">HP:90 SAN:100 | ä¾¦æŸ¥35 åŠ›é‡55 ç¥ç§˜å­¦20<br><span style="color:#27ae60;">å®æˆ˜ç»éªŒä¸°å¯Œï¼Œå±æœºæ—¶åˆ»ä¿æŒå†·é™</span></div>
        </div>
        <div class="profession-card" id="card3" onclick="selectProf('occultist')">
            <div class="profession-name">âœ¦ ç¥ç§˜å­¦è€…</div>
            <div class="profession-stats">HP:50 SAN:100 | ä¾¦æŸ¥40 åŠ›é‡20 ç¥ç§˜å­¦55<br><span style="color:#27ae60;">èƒ½æ„ŸçŸ¥æ·±æ¸Šèƒ½é‡ï¼Œç†è§£è¶…è‡ªç„¶ç°è±¡</span></div>
        </div>
        <div class="hint" id="selectHint">ç‚¹å‡»å¡ç‰‡é€‰æ‹© (0/2)</div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="gameUI" class="hidden" style="display: flex; flex-direction: column; height: 100vh;">
        <div class="team-status-bar">
            <div class="investigator-status">
                <div class="inv-header">
                    <span class="inv-name" id="name0">è°ƒæŸ¥å‘˜A</span>
                    <span class="status-label calm" id="status0">å†·é™</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">HP</span>
                    <div class="bar-container"><div class="bar-fill" id="hpBar0" style="width:100%"></div></div>
                    <span class="bar-value" id="hp0">70/70</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">SAN</span>
                    <div class="bar-container"><div class="bar-fill sanity" id="sanBar0" style="width:0%"></div></div>
                    <span class="bar-value" id="san0">0</span>
                </div>
            </div>
            <div class="investigator-status">
                <div class="inv-header">
                    <span class="inv-name" id="name1">è°ƒæŸ¥å‘˜B</span>
                    <span class="status-label calm" id="status1">å†·é™</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">HP</span>
                    <div class="bar-container"><div class="bar-fill" id="hpBar1" style="width:100%"></div></div>
                    <span class="bar-value" id="hp1">70/70</span>
                </div>
                <div class="bar-row">
                    <span class="bar-label">SAN</span>
                    <div class="bar-container"><div class="bar-fill sanity" id="sanBar1" style="width:0%"></div></div>
                    <span class="bar-value" id="san1">0</span>
                </div>
            </div>
        </div>
        <div class="game-layout">
            <div class="main-panel">
                <div class="scene-header">
                    <div class="scene-title" id="roomTitle">å‡†å¤‡</div>
                    <div class="scene-subtitle" id="roomSub">é€‰æ‹©è°ƒæŸ¥å‘˜</div>
                </div>
                <div class="main-content" id="mainContent"></div>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry system">DS10 v0.2 - æƒ…å¢ƒç³»ç»Ÿç‰ˆï¼ˆè§£å†³åº¦/æ¶åŒ–åº¦+è¡ŒåŠ¨å¡ç‰Œï¼‰</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ¤å®šåŠ¨ç”»è¦†ç›–å±‚ -->
    <div class="roll-overlay" id="rollOverlay">
        <div class="roll-display" id="rollDisplay">00</div>
        <div class="roll-result" id="rollResult"></div>
        <div class="roll-detail" id="rollDetail"></div>
        <button class="roll-close" id="rollClose" onclick="closeRoll()">ç¡®å®š</button>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">æ ‡é¢˜</div>
            <div class="modal-text" id="modalText">å†…å®¹</div>
            <button class="modal-btn" onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

<script>
// ========== æ¸¸æˆæ•°æ® ==========
var selectedProfs = [];
var team = [];
var currentRoomIdx = 0;
var clues = [];
var currentSituation = { resolve: 0, deterioration: 0, actionPoints: 3 };

// è¡ŒåŠ¨å¡ç‰Œå®šä¹‰
var actionCards = {
    investigate: { name: 'ä¾¦æŸ¥', icon: 'ğŸ”', resolve: 20, deterioration: 0, desc: 'è§£å†³åº¦+20' },
    combat: { name: 'æˆ˜æ–—', icon: 'âš”ï¸', resolve: 25, deterioration: 10, desc: 'è§£å†³åº¦+25 æ¶åŒ–åº¦+10' },
    negotiate: { name: 'äº¤æ¶‰', icon: 'ğŸ’¬', resolve: 15, deterioration: -5, desc: 'è§£å†³åº¦+15 æ¶åŒ–åº¦-5' },
    occult: { name: 'ç¥ç§˜å­¦', icon: 'âœ¦', resolve: 35, deterioration: 20, desc: 'è§£å†³åº¦+35 æ¶åŒ–åº¦+20' }
};

var professions = {
    archaeologist: { name: 'è€ƒå¤å­¦å®¶', hp: 70, maxHp: 70, san: 0, skills: {ä¾¦æŸ¥:50,åŠ›é‡:30,ç¥ç§˜å­¦:35} },
    soldier: { name: 'å‰å†›äºº', hp: 90, maxHp: 90, san: 0, skills: {ä¾¦æŸ¥:35,åŠ›é‡:55,ç¥ç§˜å­¦:20} },
    occultist: { name: 'ç¥ç§˜å­¦è€…', hp: 50, maxHp: 50, san: 0, skills: {ä¾¦æŸ¥:40,åŠ›é‡:20,ç¥ç§˜å­¦:55} }
};

// ========== å¯¹è±¡ç³»ç»Ÿ ==========
// å¯¹è±¡ç±»å‹: 'filler'(åŸºç¡€å¡«å……) / 'key'(åŸºç¡€å…³é”®) / 'story'(å‰§æƒ…)
// åˆ¤å®šæ–¹å¼: 'auto'(è‡ªåŠ¨) / 'skill:æŠ€èƒ½å'(æŠ€èƒ½åˆ¤å®š) / 'item:é“å…·å'(éœ€è¦é“å…·)
// ç»“æœåº“æ ¼å¼: { 'fumble':å¤§å¤±è´¥æ–‡æœ¬, 'fail':å¤±è´¥æ–‡æœ¬, 'success':æˆåŠŸæ–‡æœ¬, 'crit':å¤§æˆåŠŸæ–‡æœ¬ }

// ========== 13æˆ¿é—´å®Œæ•´å¯¹è±¡æ¨¡æ¿ ==========
var objectTemplates = {
    'debris': {
        id: 'debris',
        name: 'ç¢çŸ³å †',
        type: 'filler',
        icon: 'ğŸª¨',
        desc: 'é€šé“è¢«ç¢çŸ³éƒ¨åˆ†å µå¡ï¼Œä½†è¿˜æœ‰ä¸€æ¡çª„ç¼å¯ä»¥é€šè¿‡ã€‚',
        visible: 'always',
        actions: [
            {
                id: 'force',
                name: 'å¼ºè¡Œæ¨å¼€',
                desc: 'ç”¨è›®åŠ›æ¨å¼€ç¢çŸ³ï¼Œå¯èƒ½å—ä¼¤',
                cost: 1,
                roll: { type: 'skill', skill: 'åŠ›é‡', base: 30 },
                results: {
                    fumble: { text: 'ä½ è¢«ç¢çŸ³åˆ’ä¼¤ï¼Œæ‰‹è‡‚æ¸—å‡ºè¡€è¿¹ã€‚', san: 5, resolve: 0 },
                    fail: { text: 'ç¢çŸ³å¤ªé‡äº†ï¼Œä½ åªèƒ½å‹‰å¼ºæŒ¤å‡ºä¸€æ¡ç¼éš™ã€‚', san: 3, resolve: 10 },
                    success: { text: 'ä½ ç”¨å°½å…¨åŠ›æ¨å¼€ç¢çŸ³ï¼Œé€šé“å˜å®½äº†ä¸€äº›ã€‚', san: 0, resolve: 25 },
                    crit: { text: 'ä½ æ‰¾åˆ°å®Œç¾çš„å‘åŠ›ç‚¹ï¼Œç¢çŸ³è½°ç„¶å€’å¡Œï¼Œéœ²å‡ºéšè—çš„é€šé“ï¼', san: 0, resolve: 40, bonus: 'å‘ç°éšè—é€šé“' }
                }
            },
            {
                id: 'lever',
                name: 'å¯»æ‰¾æ”¯ç‚¹',
                desc: 'ä¾¦æŸ¥æˆ–å†›äººå¯ä»¥å¿…æˆåŠŸæ‰¾åˆ°æ”¯ç‚¹',
                cost: 1,
                roll: { type: 'auto', condition: 'archaeologist_or_soldier' },
                results: {
                    success: { text: 'ä½ ä»”ç»†è§‚å¯Ÿç¢çŸ³ç»“æ„ï¼Œæ‰¾åˆ°å®Œç¾çš„æ”¯ç‚¹ã€‚ç”¨æ æ†åŸç†è½»æ¾ç§»å¼€çŸ³å—ã€‚', san: 0, resolve: 30 },
                    fail: { text: 'ä½ æ²¡æœ‰ç›¸å…³ç»éªŒï¼Œåªèƒ½å°è¯•è›®åŠ›ã€‚', san: 0, resolve: 0, redirect: 'force' }
                }
            }
        ]
    },
    'symbols': {
        id: 'symbols',
        name: 'åˆ»ç—•',
        type: 'key',
        icon: 'âœï¸',
        desc: 'å¢™ä¸Šæœ‰æ–°é²œçš„åˆ’ç—•â€”â€”æœ‰äººç”¨åŒ•é¦–åˆ»ä¸‹äº†ç¬¦å·ï¼Œçœ‹èµ·æ¥æ˜¯åŒ†å¿™ä¸­ç•™ä¸‹çš„ã€‚',
        visible: 'always',
        actions: [
            {
                id: 'interpret',
                name: 'è§£è¯»ç¬¦å·',
                desc: 'ç¥ç§˜å­¦åˆ¤å®šç†è§£ç¬¦å·å«ä¹‰',
                cost: 1,
                roll: { type: 'skill', skill: 'ç¥ç§˜å­¦', base: 35 },
                results: {
                    fumble: { text: 'ä½ è¯¯è§£äº†ç¬¦å·çš„å«ä¹‰ï¼Œæ„Ÿåˆ°ä¸€é˜µè«åçš„ææƒ§ã€‚', san: 10, resolve: 0 },
                    fail: { text: 'ä½ åªèƒ½è¾¨è®¤å‡ºè¿™æ˜¯æ‹‰ä¸è¯­ï¼Œä½†å…·ä½“å«ä¹‰éš¾ä»¥ç†è§£ã€‚', san: 3, resolve: 10 },
                    success: { text: 'ä½ è®¤å‡ºè¿™æ˜¯"å±é™©"è¢«æ”¹æˆäº†"é‚€è¯·"ã€‚æœ‰äººâ€”â€”æˆ–è€…æŸç§ä¸œè¥¿â€”â€”åœ¨è¯±å¯¼åæ¥è€…æ·±å…¥ã€‚', san: 5, resolve: 25, clue: 'ç¬¦å·çœŸç›¸' },
                    crit: { text: 'ä½ ä¸ä»…è¯»æ‡‚äº†ç¬¦å·ï¼Œè¿˜å‘ç°éšè—çš„ç¬¬äºŒå±‚ä¿¡æ¯ï¼š"ä¸»æ•™å·²ä¸å†æ˜¯ä»–è‡ªå·±ã€‚"', san: 0, resolve: 35, clue: 'ä¸»æ•™çœŸç›¸' }
                }
            },
            {
                id: 'photo',
                name: 'æ‹ç…§è®°å½•',
                desc: 'éœ€è¦ç›¸æœºé“å…·ï¼ˆå¦‚æœ‰åˆ™å¿…æˆåŠŸï¼‰',
                cost: 1,
                roll: { type: 'item', item: 'ç›¸æœº' },
                results: {
                    success: { text: 'ä½ ç”¨ç›¸æœºè®°å½•ä¸‹ç¬¦å·ç»†èŠ‚ï¼Œå¯ä»¥å›å»åæ…¢æ…¢ç ”ç©¶ã€‚', san: 0, resolve: 20 },
                    fail: { text: 'ä½ æ²¡æœ‰ç›¸æœºï¼Œåªèƒ½å‡­è®°å¿†æè¿°ç¬¦å·ã€‚', san: 0, resolve: 5 }
                }
            }
        ]
    },
    'diary': {
        id: 'diary',
        name: 'æ—¥è®°',
        type: 'story',
        icon: 'ğŸ“–',
        desc: 'ä¸€æœ¬ç ´æ—§çš„æ—¥è®°ï¼Œä¼¼ä¹å±äºä¹‹å‰çš„æ¢é™©è€…ã€‚',
        visible: 'always',
        actions: [
            {
                id: 'read',
                name: 'é˜…è¯»æ—¥è®°',
                desc: 'äº†è§£ä¹‹å‰å‘ç”Ÿçš„æ•…äº‹ï¼ˆå¿…æˆåŠŸï¼Œåˆ†æ”¯å‰§æƒ…ï¼‰',
                cost: 1,
                roll: { type: 'auto' },
                branch: true,
                results: {
                    success: { 
                        text: 'æ—¥è®°è®°è½½ï¼š"11æœˆ14æ—¥ï¼šæˆ‘ä»¬æ‰¾åˆ°äº†æ·±æ¸Šå…¥å£ã€‚11æœˆ15æ—¥ï¼šé©¬åº“æ–¯é˜Ÿé•¿è¯´è¿™é‡Œä¸å¯¹åŠ²...11æœˆ16æ—¥ï¼šæˆ‘å¿…é¡»è—èµ·æ¥ï¼Œä»–ä»¬å·²ç»ä¸æ˜¯äººäº†ã€‚â€”â€”DIAç¬¬7å°é˜Ÿæˆå‘˜ç§‘æ—"',
                        san: 10, resolve: 30, clue: 'ç§‘æ—çš„æ—¥è®°'
                    }
                },
                branches: [
                    { id: 'continue', name: 'ç»§ç»­æ·±å…¥è°ƒæŸ¥', desc: 'å¯»æ‰¾æ›´å¤šçº¿ç´¢', resolve: 10 },
                    { id: 'caution', name: 'æé«˜è­¦æƒ•', desc: 'å°å¿ƒè¡Œäº‹', san: -5 }
                ]
            },
            {
                id: 'take',
                name: 'å¸¦èµ°æ—¥è®°',
                desc: 'å°†æ—¥è®°æ”¾å…¥èƒŒåŒ…',
                cost: 0,
                roll: { type: 'auto' },
                results: {
                    success: { text: 'ä½ å°†æ—¥è®°å°å¿ƒåœ°æ”¶å¥½ã€‚', item: 'æ—§æ—¥è®°', resolve: 5 }
                }
            },
            {
                id: 'burn',
                name: 'çƒ§æ¯æ—¥è®°',
                desc: 'é”€æ¯è¿™æœ¬ä¸ç¥¥çš„è®°å½•',
                cost: 0,
                roll: { type: 'auto' },
                results: {
                    success: { text: 'ç«ç„°åå™¬äº†æ—¥è®°ï¼Œä½†æŸç§æ„Ÿè§‰å‘Šè¯‰ä½ ï¼Œè¿™åªæ˜¯å¼€å§‹...', san: 15, resolve: 10 }
                }
            }
        ]
    }
};

// å½“å‰é€‰ä¸­çš„å¯¹è±¡
var selectedObject = null;
var currentRoll = null;

// 13ä¸ªæˆ¿é—´å®Œæ•´æ•°æ® (v0.2 æƒ…å¢ƒç³»ç»Ÿç‰ˆ)
var rooms = [
    {
        id: 'entrance',
        name: 'çŸ¿å‘å…¥å£',
        type: 'main',
        desc: 'å¯’é£è£¹æŒŸç€è…æœ½çš„æ°”æ¯ä»é»‘æš—ä¸­æ¶Œå‡ºã€‚\n\næ‰‹ç”µç­’çš„å…‰æŸåœ¨é”ˆè¿¹æ–‘æ–‘çš„é“è½¨ä¸Šæ‘‡æ™ƒï¼Œç…§äº®äº†å‰æ–¹åå¡Œçš„é€šé“ã€‚ä½ ä»¬ç«™åœ¨æ·±æ¸Šè£‚éš™çš„å…¥å£ï¼Œä½œä¸ºDIAç¬¬9å°é˜Ÿï¼Œä»»åŠ¡æ˜¯æ‰¾åˆ°å¤±è¸ªçš„ç¬¬7å°é˜Ÿå¹¶é˜»æ­¢æŸç§"ä»ªå¼"ã€‚\n\nèº«åçš„é€šè®¯è½¦é‡Œï¼ŒæŒ‡æŒ¥éƒ¨æœ€åçš„å£°éŸ³è¿˜åœ¨å›å“ï¼š"å¦‚æœ48å°æ—¶å†…æ²¡æœ‰å›åº”ï¼Œæˆ‘ä»¬å°†å°é”è¿™ä¸ªåŒºåŸŸã€‚ç¥ä½ ä»¬å¥½è¿ã€‚"',
        discoveries: [
            { id: 'mission', icon: 'ğŸ“‹', name: 'ä»»åŠ¡ç®€æŠ¥', text: 'DIAç¬¬7å°é˜Ÿ3å¤©å‰åœ¨æ­¤å¤±è”ã€‚æœ€åé€šè®¯æåˆ°"ä¸»æ•™"ã€"ä»ªå¼"ã€"æ·±æ¸Šä¹‹ä¸»"ã€‚' }
        ],
        choices: [
            { text: 'è¿›å…¥çŸ¿å‘', next: 1, desc: 'å¼€å§‹æ¢ç´¢æ·±æ¸Š' }
        ]
    },
    {
        id: 'collapse',
        name: 'å¡Œé™·é€šé“ [å¯¹è±¡ç³»ç»Ÿæ¼”ç¤º]',
        type: 'main',
        objectSystem: true, // å¯ç”¨å¯¹è±¡ç³»ç»Ÿ
        desc: 'é€šé“è¢«ç¢çŸ³éƒ¨åˆ†å µå¡ï¼Œä½†è¿˜æœ‰ä¸€æ¡çª„ç¼å¯ä»¥é€šè¿‡ã€‚\n\nä½ ä»¬æ³¨æ„åˆ°å¢™ä¸Šæœ‰æ–°é²œçš„åˆ’ç—•â€”â€”æœ‰äººç”¨åŒ•é¦–åˆ»ä¸‹äº†ç¬¦å·ï¼Œçœ‹èµ·æ¥æ˜¯åŒ†å¿™ä¸­ç•™ä¸‹çš„ã€‚\n\nè§’è½é‡Œè¿˜èººç€ä¸€æœ¬ç ´æ—§çš„æ—¥è®°ï¼Œä¼¼ä¹å±äºä¹‹å‰çš„æ¢é™©è€…ã€‚',
        objects: ['debris', 'symbols', 'diary'], // å¼•ç”¨å¯¹è±¡æ¨¡æ¿
        choices: [
            { text: 'è¿›å…¥é—å¼ƒè£…å¤‡å®¤', next: 2, desc: 'ç»§ç»­å‰è¿›' },
            { text: 'å‰å¾€è¯¡å¼‚å£ç”»å…', next: 3, desc: 'æ¢ç´¢ä¾§è·¯' }
        ]
    },
    {
        id: 'equipment',
        name: 'é—å¼ƒè£…å¤‡å®¤',
        type: 'side',
        desc: 'ä¸€ä¸ªä¾§å®¤ï¼Œæ˜¾ç„¶æ˜¯ç¬¬7å°é˜Ÿç•™ä¸‹çš„ä¸´æ—¶è¡¥ç»™ç‚¹ã€‚\n\nåºŠé“ºæ•´é½ï¼Œè£…å¤‡ç®±æœªæ‰“å¼€â€”â€”ä»–ä»¬ç¦»å¼€å¾—å¾ˆåŒ†å¿™ã€‚ä¸­å¤®çš„æ¡Œå­ä¸Šï¼Œä¸€ç›ç…¤æ²¹ç¯è¿˜åœ¨å¾®å¾®ç‡ƒçƒ§ï¼Œä»¿ä½›ä¸»äººåªæ˜¯æš‚æ—¶ç¦»å¼€...',
        discoveries: [
            { id: 'note', icon: 'ğŸ“„', name: 'é©¬åº“æ–¯çš„ä¾¿æ¡', text: '"å¦‚æœæˆ‘ä»¬æ²¡å›æ¥ï¼Œä¸è¦æ·±å…¥ã€‚ä¸»æ•™å·²ç»ä¸æ˜¯äººäº†ã€‚â€”â€”é©¬åº“æ–¯"' },
            { id: 'supplies', icon: 'ğŸ’Š', name: 'åŒ»ç–—ç‰©èµ„', text: '2æ”¯é•‡é™å‰‚ã€‚æ ‡ç­¾ä¸Šå†™ç€"SANç¨³å®šå‰‚ï¼Œç´§æ€¥æƒ…å†µä½¿ç”¨"ã€‚' }
        ],
        choices: [
            { text: 'æ‹¿èµ°ç‰©èµ„ç»§ç»­å‰è¿›', next: 4, desc: 'è·å¾—é•‡é™å‰‚Ã—2' },
            { text: 'ä¸ç¢°ä»»ä½•ä¸œè¥¿ç›´æ¥ç¦»å¼€', next: 4, desc: 'é¿å…æ½œåœ¨è¯…å’’' }
        ]
    },
    {
        id: 'mural',
        name: 'è¯¡å¼‚å£ç”»å…',
        type: 'side',
        desc: 'æ´ç©´å¢™å£ä¸Šå‡ºç°äº†å¤è€çš„å£ç”»ï¼Œæç»˜ç€æŸç§ä»ªå¼åœºæ™¯ã€‚\n\nç”»ä¸­äººä»¬å›´ç€ä¸€ä¸ªé»‘è‰²è£‚éš™ï¼Œä¼¼ä¹åœ¨...çŒ®ç¥­ï¼Ÿå£ç”»çš„é£æ ¼ä¸å±äºä»»ä½•å·²çŸ¥çš„å¤ä»£æ–‡æ˜ã€‚',
        discoveries: [
            { id: 'mural', icon: 'ğŸ¨', name: 'å¤è€å£ç”»', text: 'æç»˜æ·±æ¸Šä»ªå¼çš„åœºæ™¯ã€‚æ¯”ä»»ä½•å·²çŸ¥è®°å½•éƒ½è¦å¤è€ã€‚' }
        ],
        choices: [
            { text: 'ç ”ç©¶å£ç”»', next: 4, desc: 'è·å¾—æ·±æ¸ŠçŸ¥è¯†', san: 10 },
            { text: 'å¿«é€Ÿç¦»å¼€', next: 4, desc: 'å®‰å…¨ä¿å®ˆ', san: 3 }
        ]
    },
    {
        id: 'camp',
        name: 'ç¬¬7å°é˜Ÿè¥åœ°ã€ä¸»è½´ã€‘',
        type: 'main',
        desc: 'ä¸€ä¸ªç›¸å¯¹å¼€é˜”çš„æ´å®¤ï¼Œæ˜¾ç„¶æ˜¯ç¬¬7å°é˜Ÿçš„ä¸´æ—¶è¥åœ°ã€‚\n\nåºŠé“ºæ•´é½ï¼Œè£…å¤‡ç®±æœªæ‰“å¼€â€”â€”ä»–ä»¬ç¦»å¼€å¾—å¾ˆåŒ†å¿™ã€‚ä¸­å¤®çš„æ¡Œå­ä¸Šï¼Œä¸€ç›ç…¤æ²¹ç¯è¿˜åœ¨å¾®å¾®ç‡ƒçƒ§...\n\né©¬åº“æ–¯é˜Ÿé•¿çš„æ—¥è®°å°±æ‘Šå¼€åœ¨æ¡Œä¸Šã€‚',
        discoveries: [
            { id: 'diary', icon: 'ğŸ“–', name: 'é©¬åº“æ–¯çš„æ—¥è®°', text: '"11æœˆ15æ—¥ï¼šæˆ‘ä»¬æ‰¾åˆ°äº†åŸƒå¾·è’™Â·å¸ƒè±å…‹ä¼å¾·ä¸»æ•™ã€‚ä»–è¯´æ·±æ¸Šä¸æ˜¯å¨èƒï¼Œè€Œæ˜¯å±éšœã€‚æ·±æ¸Šä¹‹ä¸»æ­£åœ¨è‹é†’ï¼Œå”¯ä¸€çš„ç”Ÿå­˜æœºä¼šæ˜¯æˆä¸ºå®ˆé—¨äººè€Œéç¥­å“ã€‚11æœˆ16æ—¥ï¼šæˆ‘å¿…é¡»é˜»æ­¢ä»–ã€‚"' }
        ],
        choices: [
            { text: '"æˆ‘ä»¬å¿…é¡»é˜»æ­¢ä»ªå¼ï¼"', next: 5, desc: 'å†³å¿ƒ+é˜»æ­¢' },
            { text: '"ä»–è¯´çš„æ˜¯çœŸçš„å—ï¼Ÿ"', next: 5, desc: 'å†³å¿ƒ+çœŸç›¸' }
        ]
    },
    {
        id: 'whisper',
        name: 'ä½è¯­å›å»Š',
        type: 'main',
        desc: 'é€šé“å˜å¾—ç‹­çª„ï¼Œå¢™å£ä¸Šæ¸—å‡ºæ°´ç ã€‚\n\nä½ ä»¬å¬åˆ°äº†...ä½è¯­å£°ï¼Ÿåƒæ˜¯æœ‰äººåœ¨ä½ ä»¬è€³è¾¹è¯´è¯ï¼Œä½†å¬ä¸æ¸…å†…å®¹ã€‚å£°éŸ³ä¼¼ä¹åœ¨è¯±å¯¼ä½ ä»¬â€”â€”"æ¥å§...çœ‹çœ‹çœŸç›¸...""æ”¾å¼ƒå§...å¤ªè¿Ÿäº†..."',
        discoveries: [
            { id: 'whispers', icon: 'ğŸ‘‚', name: 'æ·±æ¸Šä½è¯­', text: 'æ— æ³•ç†è§£çš„è¯­è¨€ï¼Œä½† somehow èƒ½æ˜ç™½æ„æ€ã€‚å®ƒåœ¨è¯´ï¼š"å®ˆé—¨äººå¿…é¡»è‡ªæ„¿..."' }
        ],
        choices: [
            { text: 'æ‚ä½è€³æœµå¿«é€Ÿé€šè¿‡', next: 6, desc: 'å‡å°‘SANä¼¤å®³', san: 5 },
            { text: 'è¯•å›¾ç†è§£ä½è¯­', next: 6, desc: 'å¯èƒ½è·å¾—æƒ…æŠ¥', san: 15 }
        ]
    },
    {
        id: 'fork',
        name: 'çŸ¿é“åˆ†å‰ã€æŠ‰æ‹©ã€‘',
        type: 'main',
        desc: 'é€šé“åœ¨è¿™é‡Œåˆ†æˆä¸¤æ¡è·¯ã€‚\n\nå·¦è¾¹é€šå‘ä»ªå¼å‡†å¤‡åŒºï¼Œä½ ä»¬éšçº¦çœ‹åˆ°ç«å…‰å’Œäººå£°ã€‚\n\nå³è¾¹é€šå‘æ·±æ¸Šè¾¹ç¼˜ï¼Œä¼ æ¥ä¸ç¥¥çš„èƒ½é‡æ³¢åŠ¨...',
        choices: [
            { text: 'â¬†ï¸ å‰å¾€æ•™å¯¼å…ï¼ˆä¸Šåˆ†æ”¯ï¼‰', next: 7, desc: 'äº†è§£ä»ªå¼çš„ç§˜å¯†' },
            { text: 'â¬‡ï¸ å‰å¾€æ·±æ¸Šè¾¹ç¼˜ï¼ˆä¸‹åˆ†æ”¯ï¼‰', next: 9, desc: 'å¯»æ‰¾ç¬¬7å°é˜Ÿ' }
        ]
    },
    // ä¸Šåˆ†æ”¯
    {
        id: 'teaching',
        name: 'æ•™å¯¼å…',
        type: 'side',
        desc: 'ä¸€ä¸ªæ˜æš—çš„å¤§å…ï¼Œå¢™ä¸Šåˆ»æ»¡äº†ä½ ä»¬ä¸è®¤è¯†çš„ç¬¦å·ã€‚\n\nå‡ ä¸ªæ‘æ°‘ååœ¨åœ°ä¸Šï¼Œçœ¼ç¥ç©ºæ´ï¼Œä¼¼ä¹åœ¨åå¤èƒŒè¯µç€ä»€ä¹ˆã€‚',
        discoveries: [
            { id: 'notes', icon: 'ğŸ“š', name: 'åŸƒå¾·è’™çš„ç¬”è®°', text: '"æ·±æ¸Šä¹‹ä¸»ä¸æ˜¯ç¥ï¼Œæ˜¯æ³•åˆ™ã€‚å½“è¶³å¤Ÿå¤šçš„äººæ„è¯†åˆ°å®ƒï¼Œå°å°å°±ä¼šæ¾åŠ¨ã€‚å”¯ä¸€çš„æ–¹æ³•æ˜¯æˆä¸ºå®ˆé—¨äººâ€”â€”ä»¥ä¸€ä¸ªäººçš„æ„è¯†ä¸ºä»£ä»·ã€‚"' }
        ],
        choices: [
            { text: 'ç»§ç»­å‰å¾€è—ä¹¦å®¤', next: 8, desc: 'äº†è§£åŸƒå¾·è’™çš„è¿‡å»' }
        ]
    },
    {
        id: 'library',
        name: 'è—ä¹¦å®¤ã€ä¸»è½´ã€‘',
        type: 'main',
        desc: 'åŸƒå¾·è’™Â·å¸ƒè±å…‹ä¼å¾·çš„ç§äººç©ºé—´ï¼Œå¢™ä¸Šè´´æ»¡äº†ç ”ç©¶æŠ¥å‘Šå’Œ...ç…§ç‰‡ï¼Ÿ\n\næ˜¯DIAæˆç«‹åˆæœŸçš„åˆå½±ï¼Œå¹´è½»çš„åŸƒå¾·è’™ç«™åœ¨ä¸­å¤®ï¼Œç¬‘å®¹è‡ªä¿¡ã€‚å¦ä¸€å¼ ç…§ç‰‡ä¸Šï¼Œä»–å’Œä¸€ä¸ªå¹´è½»å¥³å­â€”â€”è‰¾ç³å¨œã€‚\n\nç…§ç‰‡èƒŒé¢å†™ç€ï¼š"è‰¾ç³å¨œï¼Œæ„¿æ·±æ¸Šæ°¸è¿œå°å°ã€‚"æ—¥æœŸæ˜¯...2å¹´å‰ï¼Ÿ',
        discoveries: [
            { id: 'photo', icon: 'ğŸ–¼ï¸', name: 'æ—§ç…§ç‰‡', text: 'åŸƒå¾·è’™å’Œä»–çš„å¦»å­è‰¾ç³å¨œã€‚ç…§ç‰‡èƒŒé¢å†™ç€"æ„¿æ·±æ¸Šæ°¸è¿œå°å°"ï¼Œæ—¥æœŸæ˜¯2å¹´å‰â€”â€”è‰¾ç³å¨œ"æ­»äº¡"ä¹‹åã€‚' }
        ],
        choices: [
            { text: 'å‰å¾€ä»ªå¼å¤§å…', next: 11, desc: 'æœ€ç»ˆå†³æˆ˜' }
        ]
    },
    // ä¸‹åˆ†æ”¯
    {
        id: 'pit',
        name: 'ç‰ºç‰²å‘é“',
        type: 'side',
        desc: 'å‘ä¸‹çš„æ–œå¡ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€è¡€è…¥å‘³ã€‚\n\nä½ ä»¬çœ‹åˆ°äº†...æ‰‹æœ¯å°ï¼Ÿè¿™æ˜¯åŸƒå¾·è’™"å¤„ç†"é‚£äº›"ä¸é€‚åˆå‚ä¸ä»ªå¼"çš„äººçš„åœ°æ–¹ã€‚',
        discoveries: [
            { id: 'survivor', icon: 'ğŸ˜°', name: 'å¹¸å­˜æ‘æ°‘', text: '"åŸƒå¾·è’™è¯´æˆ‘ä»¬ä¸çº¯å‡€ï¼Œä¸èƒ½è¢«æ·±æ¸Šæ¥å—ï¼Œæ‰€ä»¥ä»–...ç ”ç©¶æˆ‘ä»¬..."' }
        ],
        choices: [
            { text: 'ç»™ä»–è§£è„±', next: 10, desc: 'é“å¾·ç°è‰²' },
            { text: 'å°è¯•æ•‘æ²»', next: 10, desc: 'æ¶ˆè€—è¯å“' }
        ]
    },
    {
        id: 'abyss',
        name: 'æ·±æ¸Šè¾¹ç¼˜ã€ä¸»è½´ã€‘',
        type: 'main',
        desc: 'ä½ ä»¬æ¥åˆ°äº†è£‚éš™è¾¹ç¼˜ã€‚é»‘è‰²çš„è™šæ— æ‚¬æµ®åœ¨çŸ¿å‘å°½å¤´ã€‚\n\nåœ¨è£‚éš™å‰ï¼Œä½ ä»¬å‘ç°äº†é©¬åº“æ–¯é˜Ÿé•¿ã€‚ä»–æµ‘èº«æ˜¯è¡€ï¼Œä½†è¿˜æ´»ç€ã€‚\n\n"å¬ç€...åŸƒå¾·è’™...ä»–ä¸æ˜¯åäºº...ä»–åªæ˜¯...æƒ³æ•‘ä»–çš„å¦»å­..."\n\n"è‰¾ç³å¨œ...è¢«å›°åœ¨æ·±æ¸Šè¾¹ç¼˜...2å¹´äº†...å®ˆé—¨äºº...å¿…é¡»è‡ªæ„¿..."',
        discoveries: [
            { id: 'symbol', icon: 'âœ‹', name: 'ä¿æŠ¤ç¬¦å·', text: 'é©¬åº“æ–¯ç”¨æœ€åçš„åŠ›æ°”ç”»ä¸‹çš„ç¬¦å·ã€‚ä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨ï¼Œä½†æ„Ÿè§‰...æ¸©æš–ã€‚' }
        ],
        choices: [
            { text: 'å‰å¾€ä»ªå¼å¤§å…', next: 11, desc: 'ä¸ºé©¬åº“æ–¯æŠ¥ä»‡' }
        ]
    },
    // ç»ˆå±€
    {
        id: 'ritual',
        name: 'ä»ªå¼å¤§å…ã€ç»ˆå±€ã€‘',
        type: 'main',
        desc: 'ç»ˆäºæ¥åˆ°äº†æ ¸å¿ƒåŒºåŸŸã€‚ä»ªå¼æ­£åœ¨è¿›è¡Œâ€”â€”\n\né»‘è‰²çš„èƒ½é‡æŸ±ä»è£‚éš™ä¸­å‡èµ·ï¼ŒåŸƒå¾·è’™Â·å¸ƒè±å…‹ä¼å¾·ç«™åœ¨å…‰æŸ±ä¸­å¤®ï¼Œä»–çš„èº«ä½“å·²ç»å¼€å§‹ä¸æ·±æ¸ŠåŒåŒ–ã€‚\n\nåœ¨èƒ½é‡æŸ±ä¸­ï¼Œä½ ä»¬éšçº¦çœ‹åˆ°ä¸€ä¸ªäººå½±â€”â€”è‰¾ç³å¨œÂ·å¸ƒè±å…‹ä¼å¾·ï¼Œæ¼‚æµ®åœ¨è™šç©ºä¹‹ä¸­...\n\nåŸƒå¾·è’™è½¬èº«ï¼š"ä½ ä»¬æ¥äº†...æˆ‘ç­‰å¾…ç€æœ‰äººèƒ½ç†è§£æˆ‘...æˆ–è€…ï¼Œè‡³å°‘...èƒ½é˜»æ­¢æˆ‘ã€‚"',
        choices: [
            { text: 'ğŸ’¬ å°è¯•è¯´æœ', ending: 'truth', desc: 'åˆ©ç”¨äº†è§£çš„æƒ…æŠ¥' },
            { text: 'âš”ï¸ å¼ºè¡Œé˜»æ­¢', ending: 'hero', desc: 'ä¸åŸƒå¾·è’™æˆ˜æ–—' },
            { text: 'âœ¨ è‡ªæ„¿ç‰ºç‰²', ending: 'sacrifice', desc: 'æ›¿ä»£è‰¾ç³å¨œ' }
        ]
    }
];

// ========== æ¸¸æˆå‡½æ•° ==========
function selectProf(key) {
    if (selectedProfs.indexOf(key) >= 0) return;
    if (selectedProfs.length >= 2) return;
    
    selectedProfs.push(key);
    document.getElementById('selectHint').textContent = 'å·²é€‰æ‹©: ' + selectedProfs.length + '/2';
    document.getElementById('selectHint').style.color = '#27ae60';
    
    // é«˜äº®
    var ids = { archaeologist: 'card1', soldier: 'card2', occultist: 'card3' };
    var card = document.getElementById(ids[key]);
    if (card) {
        card.style.borderColor = '#27ae60';
        card.style.backgroundColor = '#1a3a2e';
    }
    
    if (selectedProfs.length === 2) {
        setTimeout(startGame, 500);
    }
}

function startGame() {
    team = [
        { key: selectedProfs[0], ...professions[selectedProfs[0]] },
        { key: selectedProfs[1], ...professions[selectedProfs[1]] }
    ];
    
    document.getElementById('professionSelect').classList.add('hidden');
    document.getElementById('gameUI').classList.remove('hidden');
    
    updateStatus();
    enterRoom(0);
}

function enterRoom(idx) {
    currentRoomIdx = idx;
    var room = rooms[idx];
    selectedObject = null;
    
    // åˆå§‹åŒ–æƒ…å¢ƒ
    currentSituation = { resolve: 0, deterioration: room.type === 'main' ? 10 : 0, actionPoints: 3 };
    
    document.getElementById('roomTitle').textContent = room.name;
    document.getElementById('roomSub').textContent = 'æˆ¿é—´ ' + (idx + 1) + '/13';
    
    var html = '<div class="room-container">';
    
    // æè¿°
    html += '<div class="room-desc">' + room.desc.replace(/\n/g, '<br>') + '</div>';
    
    // v0.2 æƒ…å¢ƒé¢æ¿
    if (room.type !== 'main' || idx === 0) {
        // éæƒ…å¢ƒæˆ¿é—´ç›´æ¥æ˜¾ç¤ºé€‰æ‹©
        // é€‰æ‹©
        html += '<div class="room-choices">';
        room.choices.forEach(function(c) {
            var onclick = '';
            if (c.next !== undefined) onclick = 'onclick="enterRoom(' + c.next + ')"';
            else if (c.ending) onclick = 'onclick="showEnding(\'' + c.ending + '\')"';
            
            html += '<button class="choice-btn" ' + onclick + '>';
            html += '<span class="choice-title">' + c.text + '</span>';
            if (c.desc) html += '<span class="choice-desc">' + c.desc + '</span>';
            html += '</button>';
        });
        html += '</div>';
    } else if (room.objectSystem) {
        // ========== å¯¹è±¡ç³»ç»Ÿæˆ¿é—´ ==========
        html += '<div class="situation-panel">';
        html += '<div class="situation-title">âš ï¸ æƒ…å¢ƒ</div>';
        html += '<div class="situation-bar">';
        html += '<span class="situation-label">è§£å†³åº¦</span>';
        html += '<div class="situation-bar-fill"><div class="situation-fill resolve" id="resolveBar" style="width:0%"></div></div>';
        html += '<span class="bar-value" id="resolveText">0/100</span>';
        html += '</div>';
        html += '<div class="situation-bar">';
        html += '<span class="situation-label">æ¶åŒ–åº¦</span>';
        html += '<div class="situation-bar-fill"><div class="situation-fill deterioration" id="deteriorationBar" style="width:' + currentSituation.deterioration + '%"></div></div>';
        html += '<span class="bar-value" id="deteriorationText">' + currentSituation.deterioration + '/100</span>';
        html += '</div>';
        html += '<div class="action-points">';
        html += '<span class="ap-label">è¡ŒåŠ¨ç‚¹</span>';
        for (var i = 0; i < 3; i++) {
            html += '<div class="ap-dot" id="ap' + i + '"></div>';
        }
        html += '</div>';
        html += '</div>';
        
        // å™äº‹æ–‡æœ¬åŒºåŸŸ
        html += '<div id="narrativeArea"></div>';
        
        // å¯¹è±¡åˆ—è¡¨
        html += '<div class="object-panel">';
        html += '<div class="object-title">ğŸ“¦ å¯äº¤äº’å¯¹è±¡ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</div>';
        html += '<div class="object-list" id="objectList">';
        room.objects.forEach(function(objId, i) {
            var obj = objectTemplates[objId];
            var typeText = { 'filler': 'ã€å¡«å……ã€‘', 'key': 'ã€å…³é”®ã€‘', 'story': 'ã€å‰§æƒ…ã€‘' }[obj.type];
            html += '<div class="object-item type-' + obj.type + '" id="obj_' + objId + '" onclick="selectObject(\'' + objId + '\')">';
            html += '<span class="object-icon">' + obj.icon + '</span>';
            html += '<span class="object-name">' + obj.name + '</span>';
            html += '<span class="object-type">' + typeText + '</span>';
            html += '</div>';
        });
        html += '</div>';
        
        // å¯¹è±¡æè¿°
        html += '<div id="objectDesc" style="display:none;font-size:12px;color:#888;margin-bottom:10px;padding:8px;background:#0f0f1a;border-radius:4px;"></div>';
        
        // è¡ŒåŠ¨åˆ—è¡¨
        html += '<div class="action-panel" id="actionPanel" style="display:none;">';
        html += '<div class="action-title">å¯ç”¨è¡ŒåŠ¨</div>';
        html += '<div class="action-list" id="actionList"></div>';
        html += '</div>';
        
        html += '</div>';
        
        // ç»“æœåé¦ˆåŒºåŸŸ
        html += '<div id="resultFeedback"></div>';
        
        // å‡ºå£æŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼‰
        html += '<div id="exitArea" style="display:none;margin-top:15px;">';
        html += '<div style="color:#27ae60;text-align:center;margin-bottom:10px;">âœ“ æƒ…å¢ƒè§£å†³</div>';
        room.choices.forEach(function(c) {
            var onclick = '';
            if (c.next !== undefined) onclick = 'onclick="enterRoom(' + c.next + ')"';
            else if (c.ending) onclick = 'onclick="showEnding(\'' + c.ending + '\')"';
            html += '<button class="choice-btn" ' + onclick + '>';
            html += '<span class="choice-title">' + c.text + '</span>';
            if (c.desc) html += '<span class="choice-desc">' + c.desc + '</span>';
            html += '</button>';
        });
        html += '</div>';
    } else {
        // ========== æ—§ç‰ˆæƒ…å¢ƒæˆ¿é—´ ==========
        // æƒ…å¢ƒæˆ¿é—´æ˜¾ç¤ºæƒ…å¢ƒç³»ç»Ÿ
        html += '<div class="situation-panel">';
        html += '<div class="situation-title">âš ï¸ æƒ…å¢ƒ</div>';
        html += '<div class="situation-bar">';
        html += '<span class="situation-label">è§£å†³åº¦</span>';
        html += '<div class="situation-bar-fill"><div class="situation-fill resolve" id="resolveBar" style="width:0%"></div></div>';
        html += '<span class="bar-value" id="resolveText">0/100</span>';
        html += '</div>';
        html += '<div class="situation-bar">';
        html += '<span class="situation-label">æ¶åŒ–åº¦</span>';
        html += '<div class="situation-bar-fill"><div class="situation-fill deterioration" id="deteriorationBar" style="width:' + currentSituation.deterioration + '%"></div></div>';
        html += '<span class="bar-value" id="deteriorationText">' + currentSituation.deterioration + '/100</span>';
        html += '</div>';
        html += '<div class="action-points">';
        html += '<span class="ap-label">è¡ŒåŠ¨ç‚¹</span>';
        for (var i = 0; i < 3; i++) {
            html += '<div class="ap-dot" id="ap' + i + '"></div>';
        }
        html += '</div>';
        html += '</div>';
        
        // å™äº‹æ–‡æœ¬åŒºåŸŸ
        html += '<div id="narrativeArea"></div>';
        
        // å‘ç°ç‰©
        if (room.discoveries && room.discoveries.length > 0) {
            html += '<div class="discoveries">';
            html += '<div class="discoveries-title">å‘ç°ç‰©ï¼ˆç‚¹å‡»é˜…è¯»ï¼‰</div>';
            room.discoveries.forEach(function(d) {
                html += '<div class="discovery-item" onclick="readDiscovery(' + idx + ', \'' + d.id + '\')">';
                html += '<span class="discovery-icon">' + d.icon + '</span>';
                html += '<span class="discovery-name">' + d.name + '</span>';
                html += '</div>';
            });
            html += '</div>';
        }
        
        // è¡ŒåŠ¨å¡ç‰Œ
        html += '<div class="card-grid" id="cardGrid">';
        var cards = ['investigate', 'combat', 'negotiate', 'occult'];
        cards.forEach(function(cardKey) {
            var card = actionCards[cardKey];
            html += '<button class="card-btn" onclick="playCard(\'' + cardKey + '\')" id="card_' + cardKey + '">';
            html += '<span class="card-icon">' + card.icon + '</span>';
            html += '<span class="card-name">' + card.name + '</span>';
            html += '<span class="card-effect">' + card.desc + '</span>';
            html += '</button>';
        });
        html += '</div>';
        
        // å‡ºå£æŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼‰
        html += '<div id="exitArea" style="display:none;margin-top:15px;">';
        html += '<div style="color:#27ae60;text-align:center;margin-bottom:10px;">âœ“ æƒ…å¢ƒè§£å†³</div>';
        room.choices.forEach(function(c) {
            var onclick = '';
            if (c.next !== undefined) onclick = 'onclick="enterRoom(' + c.next + ')"';
            else if (c.ending) onclick = 'onclick="showEnding(\'' + c.ending + '\')"';
            html += '<button class="choice-btn" ' + onclick + '>';
            html += '<span class="choice-title">' + c.text + '</span>';
            if (c.desc) html += '<span class="choice-desc">' + c.desc + '</span>';
            html += '</button>';
        });
        html += '</div>';
    }
    
    html += '</div>';
    
    document.getElementById('mainContent').innerHTML = html;
}

// æ‰“å‡ºè¡ŒåŠ¨å¡ç‰Œ
function playCard(cardKey) {
    if (currentSituation.actionPoints <= 0) return;
    if (currentSituation.resolve >= 100) return;
    
    var card = actionCards[cardKey];
    var room = rooms[currentRoomIdx];
    
    // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
    currentSituation.actionPoints--;
    document.getElementById('ap' + currentSituation.actionPoints).classList.add('used');
    
    // è®¡ç®—æ•ˆæœ
    var resolveGain = card.resolve;
    var deterGain = card.deterioration;
    
    // èŒä¸šåŠ æˆ
    if (cardKey === 'investigate' && team[0].key === 'archaeologist') resolveGain += 5;
    if (cardKey === 'combat' && team[0].key === 'soldier') resolveGain += 5;
    if (cardKey === 'occult' && team[0].key === 'occultist') resolveGain += 5;
    
    // åº”ç”¨æ•ˆæœ
    currentSituation.resolve = Math.min(100, currentSituation.resolve + resolveGain);
    currentSituation.deterioration = Math.max(0, Math.min(100, currentSituation.deterioration + deterGain));
    
    // æ›´æ–°UI
    document.getElementById('resolveBar').style.width = currentSituation.resolve + '%';
    document.getElementById('resolveText').textContent = currentSituation.resolve + '/100';
    document.getElementById('deteriorationBar').style.width = currentSituation.deterioration + '%';
    document.getElementById('deteriorationText').textContent = currentSituation.deterioration + '/100';
    
    // æ˜¾ç¤ºå™äº‹æ–‡æœ¬
    var narratives = {
        investigate: 'ä½ ä»”ç»†è§‚å¯Ÿå‘¨å›´ç¯å¢ƒï¼Œå‘ç°äº†ä¸€äº›ä¹‹å‰å¿½ç•¥çš„çº¿ç´¢ã€‚å¢™å£ä¸Šçš„åˆ»ç—•ã€åœ°ä¸Šçš„è„šå°ã€ç©ºæ°”ä¸­ä¸å¯»å¸¸çš„æ°”å‘³â€”â€”æ¯ä¸€ä¸ªç»†èŠ‚éƒ½å¯èƒ½æ˜¯å…³é”®ã€‚',
        combat: 'ä½ æ¡ç´§æ­¦å™¨ï¼Œå‡†å¤‡è¿æ¥å¯èƒ½çš„å¨èƒã€‚è‚Œè‚‰ç´§ç»·ï¼Œæ„Ÿå®˜æ•é”ï¼Œæˆ˜æ–—çš„æœ¬èƒ½æ­£åœ¨è‹é†’ã€‚',
        negotiate: 'ä½ å°è¯•ä¸å‘¨å›´çš„ç¯å¢ƒ"å¯¹è¯"ï¼Œå¯»æ‰¾å…±å­˜çš„å¯èƒ½æ€§ã€‚æœ‰æ—¶å€™ï¼Œç†è§£æ¯”å¯¹æŠ—æ›´é‡è¦ã€‚',
        occult: 'ä½ æ„Ÿå—åˆ°æ·±æ¸Šèƒ½é‡çš„æ³¢åŠ¨ï¼Œé‚£ç§åŠ›é‡æ—¢è¯±äººåˆå±é™©ã€‚ä½ å°å¿ƒç¿¼ç¿¼åœ°è§¦ç¢°å®ƒï¼Œè¯•å›¾ç†è§£å®ƒçš„æœ¬è´¨ã€‚'
    };
    
    var narrativeArea = document.getElementById('narrativeArea');
    narrativeArea.innerHTML = '<div class="narrative-text">' + narratives[cardKey] + '<br><br><span style="color:#888;">è§£å†³åº¦ +' + resolveGain + (deterGain > 0 ? ' | æ¶åŒ–åº¦ +' + deterGain : deterGain < 0 ? ' | æ¶åŒ–åº¦ ' + deterGain : '') + '</span></div>';
    
    // æ¶åŒ–åº¦è¶…è¿‡é˜ˆå€¼æ—¶å¢åŠ SAN
    if (currentSituation.deterioration >= 50) {
        addSanity(5);
    }
    
    // æ£€æŸ¥æƒ…å¢ƒè§£å†³
    if (currentSituation.resolve >= 100) {
        document.getElementById('cardGrid').style.display = 'none';
        document.getElementById('exitArea').style.display = 'block';
        narrativeArea.innerHTML += '<div class="narrative-text" style="border-color:#27ae60;">æƒ…å¢ƒå·²è§£å†³ï¼Œä½ å¯ä»¥ç¦»å¼€äº†ã€‚</div>';
    }
    
    // è¡ŒåŠ¨ç‚¹ç”¨å®Œ
    if (currentSituation.actionPoints <= 0 && currentSituation.resolve < 100) {
        document.getElementById('cardGrid').style.display = 'none';
        document.getElementById('exitArea').style.display = 'block';
        narrativeArea.innerHTML += '<div class="narrative-text" style="border-color:#e94560;">è¡ŒåŠ¨ç‚¹è€—å°½ï¼Œä½ ä¸å¾—ä¸ç¦»å¼€...</div>';
        addSanity(10);
    }
}

function readDiscovery(roomIdx, id) {
    var room = rooms[roomIdx];
    var d = room.discoveries.find(function(x) { return x.id === id; });
    if (d && clues.indexOf(d.name) < 0) {
        clues.push(d.name);
        alert(d.icon + ' ' + d.name + '\n\n' + d.text);
    }
}

function addSanity(amount) {
    team.forEach(function(inv) {
        inv.san = Math.min(100, inv.san + amount);
    });
    updateStatus();
}

function updateStatus() {
    team.forEach(function(inv, idx) {
        var el = document.getElementById('name' + idx);
        if (el) el.textContent = inv.name;
        
        el = document.getElementById('hp' + idx);
        if (el) el.textContent = inv.hp + '/' + inv.maxHp;
        
        el = document.getElementById('hpBar' + idx);
        if (el) el.style.width = (inv.hp / inv.maxHp * 100) + '%';
        
        el = document.getElementById('sanBar' + idx);
        if (el) el.style.width = (inv.san / 100 * 100) + '%';
        
        el = document.getElementById('san' + idx);
        if (el) el.textContent = inv.san;
        
        // çŠ¶æ€æ ‡ç­¾
        el = document.getElementById('status' + idx);
        if (el) {
            var state = 'calm', text = 'å†·é™';
            if (inv.san > 30) { state = 'uneasy'; text = 'ä¸å®‰'; }
            if (inv.san > 50) { state = 'nervous'; text = 'ç´§å¼ '; }
            if (inv.san > 70) { state = 'fearful'; text = 'ææƒ§'; }
            if (inv.san > 85) { state = 'breaking'; text = 'å´©æºƒ'; }
            el.className = 'status-label ' + state;
            el.textContent = text;
        }
    });
}

function showEnding(type) {
    var endings = {
        truth: { title: 'ğŸ“š çœŸç›¸ç»“å±€', text: 'ä½ è¯´æœäº†åŸƒå¾·è’™ï¼Œä¸€èµ·æ‰¾åˆ°äº†è®©æ·±æ¸Šæ²‰ç¡è€Œä¸éœ€è¦ç‰ºç‰²çš„æ–¹æ³•ã€‚è‰¾ç³å¨œè¢«é‡Šæ”¾ï¼Œè€ŒåŸƒå¾·è’™é€‰æ‹©ç»§ç»­ç ”ç©¶æ·±æ¸Šï¼Œå¯»æ‰¾æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚' },
        hero: { title: 'ğŸ† è‹±é›„ç»“å±€', text: 'ä½ å‡»è´¥äº†åŸƒå¾·è’™ï¼Œé˜»æ­¢äº†ä»ªå¼ã€‚ä½†è‰¾ç³å¨œæ°¸è¿œå›°åœ¨äº†æ·±æ¸Šè¾¹ç¼˜ï¼Œè€ŒåŸƒå¾·è’™åœ¨æœ€åæ—¶åˆ»é†’æ‚Ÿï¼Œç”¨è‡ªå·±çš„ç”Ÿå‘½å¼ºåŒ–äº†å°å°ã€‚' },
        sacrifice: { title: 'ğŸ˜¢ ç‰ºç‰²ç»“å±€', text: 'ä¸€åè°ƒæŸ¥å‘˜è‡ªæ„¿æ›¿ä»£è‰¾ç³å¨œæˆä¸ºå®ˆé—¨äººï¼Œæ°¸è¿œå›°åœ¨æ·±æ¸Šè¾¹ç¼˜ã€‚å…¶ä»–äººå›åˆ°åœ°é¢ï¼Œä½†æ°¸è¿œæ— æ³•å¿˜è®°é‚£ä¸ªèº«å½±ã€‚' }
    };
    
    var end = endings[type];
    document.getElementById('modalTitle').textContent = end.title;
    document.getElementById('modalText').innerHTML = end.text + '<br><br><button onclick="location.reload()" style="padding:10px 20px;background:#e94560;color:white;border:none;cursor:pointer;">å†ç©ä¸€æ¬¡</button>';
    document.getElementById('modal').classList.add('show');
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

// æ—¥å¿—
function log(text) {
    var panel = document.getElementById('logPanel');
    var entry = document.createElement('div');
    entry.className = 'log-entry system';
    entry.textContent = text;
    panel.appendChild(entry);
    panel.scrollTop = panel.scrollHeight;
}

// ========== å¯¹è±¡ç³»ç»Ÿå‡½æ•° ==========

// é€‰æ‹©å¯¹è±¡
function selectObject(objId) {
    selectedObject = objectTemplates[objId];
    
    // æ›´æ–°UIæ˜¾ç¤º
    document.querySelectorAll('.object-item').forEach(function(el) {
        el.classList.remove('selected');
    });
    document.getElementById('obj_' + objId).classList.add('selected');
    
    // æ˜¾ç¤ºå¯¹è±¡æè¿°
    var descEl = document.getElementById('objectDesc');
    descEl.textContent = selectedObject.desc;
    descEl.style.display = 'block';
    
    // æ˜¾ç¤ºè¡ŒåŠ¨é¢æ¿
    document.getElementById('actionPanel').style.display = 'block';
    
    // æ¸²æŸ“è¡ŒåŠ¨åˆ—è¡¨
    renderActions();
}

// è·å–è°ƒæŸ¥å‘˜çš„æŠ€èƒ½å€¼
function getSkillValue(skillName) {
    // è¿”å›é˜Ÿä¼ä¸­æœ€é«˜æŠ€èƒ½å€¼
    var maxVal = 0;
    team.forEach(function(inv) {
        if (inv.skills[skillName] && inv.skills[skillName] > maxVal) {
            maxVal = inv.skills[skillName];
        }
    });
    return maxVal;
}

// è®¡ç®—æˆåŠŸç‡
function calculateSuccessRate(roll) {
    if (roll.type === 'auto') return 100;
    if (roll.type === 'item') {
        // æ£€æŸ¥æ˜¯å¦æœ‰é“å…·
        return clues.indexOf(roll.item) >= 0 ? 100 : 0;
    }
    if (roll.type === 'skill') {
        var skillVal = getSkillValue(roll.skill);
        // æ£€æŸ¥èŒä¸šåŠ æˆ
        if (roll.skill === 'åŠ›é‡' && team.some(function(i) { return i.key === 'soldier'; })) {
            skillVal = Math.min(99, skillVal + 10);
        }
        if (roll.skill === 'ç¥ç§˜å­¦' && team.some(function(i) { return i.key === 'occultist'; })) {
            skillVal = Math.min(99, skillVal + 10);
        }
        if (roll.skill === 'ä¾¦æŸ¥' && team.some(function(i) { return i.key === 'archaeologist'; })) {
            skillVal = Math.min(99, skillVal + 10);
        }
        return skillVal;
    }
    return 50;
}

// æ¸²æŸ“è¡ŒåŠ¨åˆ—è¡¨
function renderActions() {
    if (!selectedObject) return;
    
    var html = '';
    selectedObject.actions.forEach(function(action) {
        var rate = calculateSuccessRate(action.roll);
        var hasAP = currentSituation.actionPoints >= action.cost;
        var canDo = hasAP && rate > 0;
        
        var rateText = rate === 100 ? 'å¿…æˆåŠŸ' : rate + '%æˆåŠŸç‡';
        if (rate === 0) rateText = 'ç¼ºå°‘é“å…·';
        
        html += '<button class="action-btn" onclick="executeAction(\'' + action.id + '\')" ' + (canDo ? '' : 'disabled') + '>';
        html += '<div class="action-info">';
        html += '<span class="action-name">' + action.name + '</span>';
        html += '<span class="action-desc">' + action.desc + '</span>';
        html += '</div>';
        html += '<div class="action-meta">';
        html += '<span class="action-cost">' + action.cost + 'AP</span>';
        html += '<span class="action-rate">' + rateText + '</span>';
        html += '</div>';
        html += '</button>';
    });
    
    document.getElementById('actionList').innerHTML = html;
}

// æ‰§è¡Œè¡ŒåŠ¨
function executeAction(actionId) {
    if (!selectedObject) return;
    if (currentSituation.actionPoints <= 0) return;
    if (currentSituation.resolve >= 100) return;
    
    var action = selectedObject.actions.find(function(a) { return a.id === actionId; });
    if (!action) return;
    
    // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
    currentSituation.actionPoints -= action.cost;
    for (var i = 0; i < 3; i++) {
        var apEl = document.getElementById('ap' + i);
        if (apEl) {
            apEl.classList.toggle('used', i >= currentSituation.actionPoints);
        }
    }
    
    // æ‰§è¡Œåˆ¤å®š
    performRoll(action);
}

// æ‰§è¡Œåˆ¤å®š
function performRoll(action) {
    var roll = action.roll;
    var rate = calculateSuccessRate(roll);
    
    // å¦‚æœæ˜¯æ¡ä»¶è‡ªåŠ¨æˆåŠŸï¼ˆå¦‚è€ƒå¤å­¦å®¶æˆ–å†›äººï¼‰
    if (roll.type === 'auto' && roll.condition === 'archaeologist_or_soldier') {
        var hasSpecialist = team.some(function(i) { return i.key === 'archaeologist' || i.key === 'soldier'; });
        if (hasSpecialist) {
            rate = 100;
        } else {
            // æ²¡æœ‰ä¸“å®¶ï¼Œé‡å®šå‘åˆ°åŠ›é‡åˆ¤å®š
            rate = getSkillValue('åŠ›é‡');
        }
    }
    
    currentRoll = { action: action, rate: rate };
    
    // æ˜¾ç¤ºåˆ¤å®šåŠ¨ç”»
    var overlay = document.getElementById('rollOverlay');
    var display = document.getElementById('rollDisplay');
    var resultEl = document.getElementById('rollResult');
    var detailEl = document.getElementById('rollDetail');
    
    overlay.classList.add('show');
    resultEl.style.display = 'none';
    detailEl.style.display = 'none';
    document.getElementById('rollClose').style.display = 'none';
    
    // æ•°å­—è·³åŠ¨åŠ¨ç”»
    var finalRoll = Math.floor(Math.random() * 100) + 1;
    var iterations = 0;
    var maxIterations = 20;
    
    var interval = setInterval(function() {
        display.textContent = String(Math.floor(Math.random() * 100) + 1).padStart(2, '0');
        iterations++;
        
        if (iterations >= maxIterations) {
            clearInterval(interval);
            display.textContent = String(finalRoll).padStart(2, '0');
            showRollResult(finalRoll, rate, action);
        }
    }, 50);
}

// æ˜¾ç¤ºåˆ¤å®šç»“æœ
function showRollResult(roll, rate, action) {
    var resultType, resultText;
    
    // åˆ¤å®šç»“æœåˆ†çº§
    if (roll <= 5) {
        resultType = 'fumble';
        resultText = 'å¤§å¤±è´¥ï¼';
    } else if (roll <= rate) {
        if (roll >= 96) {
            resultType = 'crit';
            resultText = 'å¤§æˆåŠŸï¼';
        } else {
            resultType = 'success';
            resultText = 'æˆåŠŸ';
        }
    } else {
        resultType = 'fail';
        resultText = 'å¤±è´¥';
    }
    
    // å¦‚æœæ²¡æœ‰å¤§æˆåŠŸ/å¤§å¤±è´¥çš„å®šä¹‰ï¼Œä½¿ç”¨æ™®é€šæˆåŠŸ/å¤±è´¥
    var resultData = action.results[resultType] || action.results.success || action.results.fail;
    
    // å¦‚æœæ˜¯è‡ªåŠ¨æˆåŠŸä½†è¢«åˆ¤å®šä¸ºå¤±è´¥ï¼Œå¼ºåˆ¶æ”¹ä¸ºæˆåŠŸ
    if (rate === 100 && resultType === 'fail') {
        resultType = 'success';
        resultText = 'æˆåŠŸ';
        resultData = action.results.success;
    }
    
    currentRoll.resultType = resultType;
    currentRoll.resultData = resultData;
    
    var resultEl = document.getElementById('rollResult');
    var detailEl = document.getElementById('rollDetail');
    
    resultEl.className = 'roll-result ' + resultType;
    resultEl.textContent = resultText;
    resultEl.style.display = 'block';
    
    detailEl.textContent = 'åˆ¤å®š: d100=' + roll + ' / ç›®æ ‡=' + rate;
    detailEl.style.display = 'block';
    
    document.getElementById('rollClose').style.display = 'block';
}

// å…³é—­åˆ¤å®šåŠ¨ç”»å¹¶æ‰§è¡Œç»“æœ
function closeRoll() {
    document.getElementById('rollOverlay').classList.remove('show');
    
    if (currentRoll && currentRoll.resultData) {
        executeActionResult(currentRoll);
    }
}

// æ‰§è¡Œè¡ŒåŠ¨ç»“æœ
function executeActionResult(rollData) {
    var result = rollData.resultData;
    var action = rollData.action;
    
    // åº”ç”¨æ•ˆæœ
    if (result.san) {
        addSanity(result.san);
    }
    if (result.resolve) {
        currentSituation.resolve = Math.min(100, currentSituation.resolve + result.resolve);
        document.getElementById('resolveBar').style.width = currentSituation.resolve + '%';
        document.getElementById('resolveText').textContent = currentSituation.resolve + '/100';
    }
    if (result.clue && clues.indexOf(result.clue) < 0) {
        clues.push(result.clue);
    }
    
    // ä¸‰å±‚å™äº‹åé¦ˆ
    var feedbackHtml = '<div class="result-feedback">';
    feedbackHtml += '<div class="result-layer layer-action">â–¶ ' + selectedObject.name + ' - ' + action.name + '</div>';
    feedbackHtml += '<div class="result-layer layer-roll">' + getRollResultText(rollData.resultType) + '</div>';
    feedbackHtml += '<div class="result-layer layer-narrative">' + result.text + '</div>';
    
    // æ˜¾ç¤ºæ•ˆæœ
    var effects = [];
    if (result.resolve) effects.push('è§£å†³åº¦ +' + result.resolve);
    if (result.san) effects.push('ç†æ™º +' + result.san);
    if (result.clue) effects.push('è·å¾—çº¿ç´¢: ' + result.clue);
    if (result.bonus) effects.push('é¢å¤–: ' + result.bonus);
    if (effects.length > 0) {
        feedbackHtml += '<div style="margin-top:8px;font-size:11px;color:#27ae60;">' + effects.join(' | ') + '</div>';
    }
    
    feedbackHtml += '</div>';
    
    document.getElementById('resultFeedback').innerHTML = feedbackHtml;
    
    // æ›´æ–°è¡ŒåŠ¨åˆ—è¡¨ï¼ˆåˆ·æ–°å¯ç”¨çŠ¶æ€ï¼‰
    renderActions();
    
    // æ£€æŸ¥æƒ…å¢ƒè§£å†³
    if (currentSituation.resolve >= 100) {
        document.getElementById('actionPanel').style.display = 'none';
        document.getElementById('objectDesc').innerHTML += '<br><span style="color:#27ae60;">âœ“ æƒ…å¢ƒå·²è§£å†³</span>';
        document.getElementById('exitArea').style.display = 'block';
    }
    
    // è¡ŒåŠ¨ç‚¹ç”¨å®Œ
    if (currentSituation.actionPoints <= 0 && currentSituation.resolve < 100) {
        document.getElementById('actionPanel').style.display = 'none';
        document.getElementById('objectDesc').innerHTML += '<br><span style="color:#e94560;">âœ— è¡ŒåŠ¨ç‚¹è€—å°½</span>';
        document.getElementById('exitArea').style.display = 'block';
        addSanity(10);
    }
}

// è·å–åˆ¤å®šç»“æœæ–‡æœ¬
function getRollResultText(type) {
    var texts = {
        'fumble': 'ğŸ’€ å¤§å¤±è´¥ (â‰¤5)',
        'fail': 'âŒ å¤±è´¥',
        'success': 'âœ“ æˆåŠŸ',
        'crit': 'â­ å¤§æˆåŠŸ (â‰¥96)'
    };
    return texts[type] || type;
}
</script>
</body>
</html>