<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS11 - è¿·é›¾åˆ†æ”¯ç½‘æ ¼ (æ¨¡å—åŒ–ç‰ˆ)</title>
    <link rel="stylesheet" href="css/game.css">
</head>
<body>
    <div class="game-title">DS11 - è¿·é›¾åˆ†æ”¯ç½‘æ ¼ v2.0 æ¨¡å—åŒ–</div>
    
    <!-- éš¾åº¦é€‰æ‹© -->
    <div class="difficulty-select" id="difficultySelect" style="margin-bottom: 20px;">
        <button class="btn" onclick="startGame('easy')">ğŸŸ¢ ç®€å•</button>
        <button class="btn" onclick="startGame('normal')">ğŸŸ¡ æ ‡å‡†</button>
        <button class="btn" onclick="startGame('hard')">ğŸ”´ å›°éš¾</button>
    </div>
    
    <!-- æ¸¸æˆä¿¡æ¯ -->
    <div class="game-info" id="gameInfo" style="display: none;">
        <div class="info-item">
            <div class="info-label">å·²æ­ç¤º</div>
            <div class="info-value" id="revealedCount">1</div>
        </div>
        <div class="info-item">
            <div class="info-label">è¿·é›¾è¾¹ç¼˜</div>
            <div class="info-value" id="edgeCount">8</div>
        </div>
        <div class="info-item">
            <div class="info-label">æ·±æ¸Šè£‚éš™</div>
            <div class="info-value" id="riftCount">0</div>
        </div>
        <div class="info-item" id="torchInfo">
            <div class="info-label">ğŸ”¥ ç«æŠŠ</div>
            <div class="info-value torch" id="torchCount">6/12</div>
        </div>
        <div class="info-item" id="markInfo">
            <div class="info-label">ğŸ‘ï¸ å°è®°</div>
            <div class="info-value" id="markCount">0/3</div>
        </div>
        <div class="info-item" id="limitInfo" style="display: none; border-color: #e94560;">
            <div class="info-label">âš ï¸ è¿·é›¾ä¸Šé™</div>
            <div class="info-value" id="limitCount" style="color: #e94560;">18/18</div>
        </div>
        <div class="info-item mutation-info" id="mutationInfo" style="display: none;">
            <div class="info-label">âš¡ ç•¸å˜</div>
            <div class="info-value mutation" id="mutationName">æ— </div>
        </div>
        <div class="info-item" id="coreInfo" style="display: none;">
            <div class="info-label">ğŸ’ æ ¸å¿ƒ</div>
            <div class="info-value" id="coreStatus">æœªæ‰¾åˆ°</div>
        </div>
    </div>
    
    <!-- æ¸¸æˆç½‘æ ¼ -->
    <div class="grid-container" id="gridContainer" style="display: none;"></div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls" id="gameControls" style="display: none;">
        <button class="btn" onclick="game.restart()">é‡æ–°å¼€å§‹</button>
        <button class="btn retreat-btn" onclick="game.retreat()">ğŸƒ æ’¤é€€</button>
    </div>
    
    <!-- æ—¥å¿—é¢æ¿ -->
    <div class="log-panel" id="logPanel" style="display: none;"></div>
    
    <!-- ç•¸å˜é€‰æ‹©é®ç½© -->
    <div class="overlay mutation-overlay" id="mutationOverlay">
        <div class="mutation-title">âš¡ ç•¸å˜é™ä¸´</div>
        <div class="mutation-desc">ä½ å·²ç´¯ç§¯è¶³å¤Ÿå°è®°ï¼Œå¿…é¡»é€‰æ‹©ä¸€ç§ç•¸å˜</div>
        <div class="mutation-options" id="mutationOptions"></div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸé®ç½© -->
    <div class="overlay" id="gameOverOverlay">
        <div class="game-over-title">æ¸¸æˆç»“æŸ</div>
        <div class="game-over-reason" id="gameOverReason">ç«æŠŠè€—å°½</div>
        <button class="btn" onclick="showDifficultySelect()">é€‰æ‹©éš¾åº¦</button>
    </div>
    
    <!-- èƒœåˆ©é®ç½© -->
    <div class="overlay" id="winOverlay">
        <div class="win-title">ğŸ‰ ä»»åŠ¡å®Œæˆï¼</div>
        <div class="win-reason" id="winReason">æˆåŠŸæ‰¾åˆ°æ ¸å¿ƒå¹¶æ’¤é€€</div>
        <div class="score-display" id="scoreDisplay">å¾—åˆ†ï¼š0</div>
        <div class="score-breakdown" id="scoreBreakdown"></div>
        <button class="btn" onclick="showDifficultySelect()">å†ç©ä¸€æ¬¡</button>
    </div>

    <!-- åŠ è½½æ¨¡å— -->
    <script src="js/config/difficulty.js"></script>
    <script src="js/config/mutation.js"></script>
    <script src="js/core/Game.js"></script>
    <script src="js/ui/Renderer.js"></script>
    <script src="js/debug-panel.js"></script>
    
    <script>
        let game = null;
        let renderer = null;
        let logger = null;
        
        // æ—¥å¿—ç³»ç»Ÿ
        function log(message, type = 'system') {
            const panel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame(difficulty) {
            // éšè—éš¾åº¦é€‰æ‹©ï¼Œæ˜¾ç¤ºæ¸¸æˆ
            document.getElementById('difficultySelect').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'flex';
            document.getElementById('gridContainer').style.display = 'grid';
            document.getElementById('gameControls').style.display = 'flex';
            document.getElementById('logPanel').style.display = 'block';
            
            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('logPanel').innerHTML = '';
            
            // åˆ›å»ºæ¸¸æˆå®ä¾‹
            game = new MistGridGame({
                difficulty: DifficultyConfig[difficulty]
            });
            
            // ç»‘å®šå›è°ƒ
            game.on('init', () => {
                log(`æ¸¸æˆå¼€å§‹ï¼éš¾åº¦ï¼š${game.config.name}`, 'system');
                log(`ç«æŠŠï¼š${game.state.torch}ï¼Œç‚¹å‡»è¿·é›¾è¾¹ç¼˜æ ¼è¿›è¡Œæ´¾é£æ­ç¤º`, 'system');
            });
            
            game.on('cellReveal', (data) => {
                log(`æ¶ˆè€— ${data.cost} ç«æŠŠæ­ç¤ºæ ¼å­`, 'system');
            });
            
            game.on('torchChange', (data) => {
                if (data.delta > 0) log(`è·å¾— ${data.delta} ç«æŠŠï¼å½“å‰ï¼š${data.torch}`, 'reward');
            });
            
            game.on('torchFound', (data) => {
                log(`å‘ç°ç«æŠŠå †ï¼è·å¾— ${data.amount} ç«æŠŠ`, 'reward');
            });
            
            game.on('markGain', (data) => {
                log(`è·å¾—å°è®°ï¼å½“å‰ï¼š${data.marks}/${data.cap}`, 'system');
            });
            
            game.on('mutationSelect', (data) => {
                renderer.showMutationSelect(data.mutations, (id) => {
                    game.selectMutation(id);
                });
            });
            
            game.on('mutationAcquired', (data) => {
                log(`è·å¾—ç•¸å˜ï¼š${data.mutation.name} - ${data.mutation.description}`, 'event');
            });
            
            game.on('riftFound', () => {
                log('å‘ç°æ·±æ¸Šè£‚éš™ï¼å‘3ä¸ªæ–¹å‘æ‰“å¼€æ–°è·¯å¾„', 'event');
            });
            
            game.on('f3Trigger', () => {
                log('è¸©ä¸­é›·æ ¼ï¼è§¦å‘F3å¼ºåˆ¶æ­ç¤º', 'event');
            });
            
            game.on('coreAppear', (data) => {
                const msg = data.guaranteed ? 'æ·±æ¸Šæ ¸å¿ƒå‡ºç°ï¼ˆä¿åº•ï¼‰ï¼' : 'æ·±æ¸Šæ ¸å¿ƒå‡ºç°ï¼';
                log(`ğŸ’ ${msg}æ‰¾åˆ°å®ƒå¯ä»¥å®Œæˆä»»åŠ¡`, 'reward');
            });
            
            game.on('coreFound', () => {
                log('ğŸ’ æ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒï¼ç°åœ¨å¯ä»¥æ’¤é€€å®Œæˆä»»åŠ¡', 'reward');
            });
            
            game.on('obsessiveBlock', (data) => {
                log(`å¼ºè¿«ç—‡ç•¸å˜ï¼šè¿˜æœ‰ ${data.remaining} ä¸ªè¿·é›¾æ ¼æœªæ­ç¤ºï¼Œä¸èƒ½æ’¤é€€ï¼`, 'warning');
            });
            
            game.on('insufficientTorch', (data) => {
                log(`ç«æŠŠä¸è¶³ï¼éœ€è¦ ${data.required} ä¸ªï¼Œå½“å‰åªæœ‰ ${data.current} ä¸ª`, 'warning');
            });
            
            game.on('gameEnd', (data) => {
                renderer.showGameEnd(data.won, data);
                if (data.won && data.coreFound) {
                    log('ğŸ‰ ä»»åŠ¡å®Œæˆï¼è·å¾—æ·±æ¸Šæ ¸å¿ƒå¹¶æˆåŠŸæ’¤é€€', 'reward');
                } else if (data.won) {
                    log('ä»»åŠ¡ç»“æŸï¼šæ’¤é€€æ—¶æœªæ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒ', 'warning');
                } else {
                    log('æ¸¸æˆç»“æŸï¼šç«æŠŠè€—å°½', 'event');
                }
            });
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new GameRenderer('gridContainer');
            renderer.bind(game);
            
            // åˆå§‹åŒ–
            game.init();
        }
        
        // æ˜¾ç¤ºéš¾åº¦é€‰æ‹©
        function showDifficultySelect() {
            document.getElementById('difficultySelect').style.display = 'block';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('gridContainer').style.display = 'none';
            document.getElementById('gameControls').style.display = 'none';
            document.getElementById('logPanel').style.display = 'none';
            document.getElementById('gameOverOverlay').classList.remove('show');
            document.getElementById('winOverlay').classList.remove('show');
        }
    </script>
</body>
</html>
