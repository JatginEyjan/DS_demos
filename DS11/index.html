<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS11 - è¿·é›¾åˆ†æ”¯ç½‘æ ¼ v1.1 å¹³è¡¡ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .game-title {
            color: #e94560;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .game-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .info-item {
            background: #1a1a2e;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #2a2a3a;
        }
        
        .info-item.torch-low {
            border-color: #e94560;
            animation: pulse-red 1s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 5px #e94560; }
            50% { box-shadow: 0 0 15px #e94560; }
        }
        
        .info-label {
            color: #666;
            font-size: 12px;
        }
        
        .info-value {
            color: #e94560;
            font-size: 18px;
            font-weight: bold;
        }
        
        .info-value.torch {
            color: #f39c12;
        }
        
        .info-value.mutation {
            color: #9b59b6;
        }
        
        .mutation-info {
            border-color: #9b59b6;
            animation: pulse-purple 2s infinite;
        }
        
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 5px #9b59b6; }
            50% { box-shadow: 0 0 15px #9b59b6; }
        }
        
        .grid-container {
            display: grid;
            gap: 8px;
            margin: 20px 0;
            padding: 20px;
            background: #0f0f1a;
            border-radius: 12px;
            border: 2px solid #2a2a3a;
        }
        
        .cell {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: bold;
            position: relative;
        }
        
        .cell.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* è¿·é›¾æ ¼ */
        .cell.fog {
            background: #1a1a2e;
            border: 2px solid #3a3a4a;
            color: #666;
        }
        
        .cell.fog:hover:not(.disabled) {
            border-color: #e94560;
            background: #2a1a2e;
        }
        
        /* å®‰å…¨æ ¼ */
        .cell.safe {
            background: #1a3a2e;
            border: 2px solid #27ae60;
            color: #27ae60;
        }
        
        .cell.safe:hover {
            background: #2a4a3e;
        }
        
        /* æ·±æ¸Šè£‚éš™ */
        .cell.rift {
            background: #3a1a4e;
            border: 2px solid #9b59b6;
            color: #9b59b6;
            animation: pulse 2s infinite;
            position: relative;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px #9b59b6; }
            50% { box-shadow: 0 0 20px #9b59b6; }
        }
        
        /* è£‚éš™æç¤º */
        .cell.rift::before {
            content: '5ğŸ”¥â†’3ğŸšª';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: #f39c12;
            background: rgba(0,0,0,0.7);
            padding: 1px 3px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        /* é›·æ ¼ */
        .cell.mine {
            background: #3a1a1e;
            border: 2px solid #e94560;
            color: #e94560;
        }
        
        /* æ ¸å¿ƒæ ¼ */
        .cell.core {
            background: #2a2a1e;
            border: 3px solid #f39c12;
            color: #f39c12;
            animation: glow-core 2s infinite;
        }
        
        @keyframes glow-core {
            0%, 100% { box-shadow: 0 0 10px #f39c12, inset 0 0 10px rgba(243,156,18,0.3); }
            50% { box-shadow: 0 0 30px #f39c12, inset 0 0 20px rgba(243,156,18,0.5); }
        }
        
        /* F3è§¦å‘åŠ¨ç”» */
        .cell.f3-trigger {
            animation: f3-shake 0.5s ease-in-out;
            border-color: #e94560 !important;
            box-shadow: 0 0 30px #e94560 !important;
        }
        
        @keyframes f3-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* æ±¡æŸ“æ ¼ */
        .cell.polluted {
            position: relative;
        }
        
        .cell.polluted::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            border: 3px solid #9b59b6;
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* ä¸­å¿ƒæ ¼ */
        .cell.center {
            background: #1a2a3e;
            border: 2px solid #3498db;
            color: #3498db;
        }
        
        /* è¾¹ç¼˜æ ¼æŒ‡ç¤º */
        .cell.edge {
            position: relative;
        }
        
        .cell.edge::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 1px dashed #666;
            border-radius: 12px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* ç«æŠŠæ¶ˆè€—æç¤º */
        .cell .cost-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #f39c12;
            color: #000;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .log-panel {
            width: 100%;
            max-width: 600px;
            height: 150px;
            background: #0f0f1a;
            border: 2px solid #2a2a3a;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-left: 3px solid #3a3a4a;
            padding-left: 10px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #888;
        }
        
        .log-entry.system {
            border-left-color: #3498db;
            color: #5dade2;
        }
        
        .log-entry.event {
            border-left-color: #e94560;
            color: #e94560;
        }
        
        .log-entry.reward {
            border-left-color: #27ae60;
            color: #27ae60;
        }
        
        .log-entry.warning {
            border-left-color: #f39c12;
            color: #f39c12;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #1a1a2e;
            border: 2px solid #2a2a3a;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 6px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .btn:hover {
            border-color: #e94560;
            background: #2a1a2e;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn.retreat-btn {
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .btn.retreat-btn:hover {
            background: #1a3a2e;
            border-color: #27ae60;
        }
        
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .game-over-overlay.show {
            display: flex;
        }
        
        .game-over-title {
            color: #e94560;
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        .game-over-reason {
            color: #888;
            margin-bottom: 30px;
        }
        
        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10,10,15,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .win-overlay.show {
            display: flex;
        }
        
        .win-title {
            color: #27ae60;
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #27ae60;
        }
        
        .win-reason {
            color: #888;
            margin-bottom: 20px;
        }
        
        .score-display {
            color: #f39c12;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .score-breakdown {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.6;
        }
        
        .mutation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10,10,15,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
            padding: 40px;
        }
        
        .mutation-overlay.show {
            display: flex;
        }
        
        .mutation-title {
            color: #9b59b6;
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #9b59b6;
        }
        
        .mutation-desc {
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .mutation-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 800px;
        }
        
        .mutation-card {
            background: #1a1a2e;
            border: 2px solid #2a2a3a;
            border-radius: 12px;
            padding: 20px;
            width: 200px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mutation-card:hover {
            border-color: #9b59b6;
            background: #2a1a3e;
            transform: translateY(-5px);
        }
        
        .mutation-card.positive {
            border-color: #27ae60;
        }
        
        .mutation-card.positive:hover {
            border-color: #27ae60;
            background: #1a3a2e;
        }
        
        .mutation-card.negative {
            border-color: #e94560;
        }
        
        .mutation-card.negative:hover {
            border-color: #e94560;
            background: #3a1a1e;
        }
        
        .mutation-card.easter {
            border-color: #f39c12;
        }
        
        .mutation-card.easter:hover {
            border-color: #f39c12;
            background: #3a2a1e;
        }
        
        .mutation-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .mutation-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #e0e0e0;
        }
        
        .mutation-desc-text {
            font-size: 12px;
            color: #888;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="game-title">DS11 - è¿·é›¾åˆ†æ”¯ç½‘æ ¼ï¼ˆDay2ï¼šç«æŠŠç³»ç»Ÿï¼‰</div>
    
    <div class="game-info">
        <div class="info-item">
            <div class="info-label">å·²æ­ç¤º</div>
            <div class="info-value" id="revealedCount">1</div>
        </div>
        <div class="info-item">
            <div class="info-label">è¿·é›¾è¾¹ç¼˜</div>
            <div class="info-value" id="edgeCount">8</div>
        </div>
        <div class="info-item">
            <div class="info-label">æ·±æ¸Šè£‚éš™</div>
            <div class="info-value" id="riftCount">0</div>
        </div>
        <div class="info-item" id="torchInfo">
            <div class="info-label">ğŸ”¥ ç«æŠŠ</div>
            <div class="info-value torch" id="torchCount">5/10</div>
        </div>
        <div class="info-item" id="markInfo">
            <div class="info-label">ğŸ‘ï¸ å°è®°</div>
            <div class="info-value" id="markCount">0/3</div>
        </div>
        <div class="info-item" id="limitInfo" style="display: none; border-color: #e94560;">
            <div class="info-label">âš ï¸ è¿·é›¾ä¸Šé™</div>
            <div class="info-value" id="limitCount" style="color: #e94560;">18/18</div>
        </div>
        <div class="info-item mutation-info" id="mutationInfo" style="display: none;">
            <div class="info-label">âš¡ ç•¸å˜</div>
            <div class="info-value mutation" id="mutationName">æ— </div>
        </div>
        <div class="info-item" id="coreInfo" style="display: none;">
            <div class="info-label">ğŸ’ æ ¸å¿ƒ</div>
            <div class="info-value" id="coreStatus">æœªæ‰¾åˆ°</div>
        </div>
    </div>
    
    <div class="grid-container" id="gridContainer"></div>
    
    <div class="controls">
        <button class="btn" onclick="game.restart()">é‡æ–°å¼€å§‹</button>
        <button class="btn" onclick="game.autoReveal()">è‡ªåŠ¨æ­ç¤º</button>
        <button class="btn retreat-btn" onclick="game.retreat()">ğŸƒ æ’¤é€€</button>
    </div>
    
    <div class="log-panel" id="logPanel"></div>
    
    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-title">æ¸¸æˆç»“æŸ</div>
        <div class="game-over-reason" id="gameOverReason">ç«æŠŠè€—å°½</div>
        <button class="btn" onclick="game.restart()">é‡æ–°å¼€å§‹</button>
    </div>
    
    <div class="win-overlay" id="winOverlay">
        <div class="win-title">ğŸ‰ ä»»åŠ¡å®Œæˆï¼</div>
        <div class="win-reason" id="winReason">æˆåŠŸæ‰¾åˆ°æ ¸å¿ƒå¹¶æ’¤é€€</div>
        <div class="score-display" id="scoreDisplay">å¾—åˆ†ï¼š0</div>
        <div class="score-breakdown" id="scoreBreakdown"></div>
        <button class="btn" onclick="game.restart()">å†ç©ä¸€æ¬¡</button>
    </div>
    
    <div class="mutation-overlay" id="mutationOverlay">
        <div class="mutation-title">âš¡ ç•¸å˜é™ä¸´</div>
        <div class="mutation-desc">ä½ å·²ç´¯ç§¯3ä¸ªå°è®°ï¼Œå¿…é¡»é€‰æ‹©ä¸€ç§ç•¸å˜</div>
        <div class="mutation-options" id="mutationOptions"></div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒç±»
        class MistGridGame {
            constructor() {
                this.grid = new Map();
                this.revealedCells = new Set();
                this.edgeCells = new Set();
                this.revealedCount = 0;
                this.riftCount = 0;
                
                // Day2: ç«æŠŠç³»ç»Ÿ
                this.torch = 6;        // å½“å‰ç«æŠŠ (è°ƒæ•´: 5â†’6)
                this.maxTorch = 12;    // ç«æŠŠä¸Šé™ (è°ƒæ•´: 10â†’12)
                this.gameOver = false; // æ¸¸æˆç»“æŸçŠ¶æ€
                
                // Day3: F4å°è®°ç³»ç»Ÿ
                this.marks = 0;        // å½“å‰å°è®°
                this.maxMarks = 3;     // å°è®°ä¸Šé™ï¼ˆè§¦å‘ç•¸å˜ï¼‰
                this.mutation = null;  // å½“å‰ç•¸å˜
                this.eyeAbilityUsed = false;
                
                // Day4: æ¸¸æˆå¾ªç¯
                this.coreFound = false;  // æ˜¯å¦æ‰¾åˆ°æ ¸å¿ƒ
                this.corePosition = null; // æ ¸å¿ƒä½ç½®
                this.score = 0;          // å¾—åˆ†
                this.gameWon = false;    // æ¸¸æˆèƒœåˆ©çŠ¶æ€
                
                // Day5: å¹³è¡¡å‚æ•° (è°ƒæ•´)
                this.maxCells = 18;      // è¿·é›¾æ ¼ä¸Šé™ (è°ƒæ•´: 15â†’18)
                this.coreGuarantee = 18; // æ ¸å¿ƒä¿åº•æ ¼æ•° (æ–°å¢)
                this.fogCellsCount = 0;  // å½“å‰è¿·é›¾æ ¼æ•°é‡
                this.gameStartedAt = Date.now();
                
                this.mutationData = {  // ç•¸å˜æ•°æ®
                    'eye': {
                        name: 'æ·±æ¸Šä¹‹çœ¼',
                        icon: 'ğŸ‘ï¸',
                        type: 'positive',
                        desc: 'å¯ä»¥é€è§†1æ ¼è¿·é›¾ï¼Œæ¯å›åˆé™1æ¬¡',
                        effect: 'reveal_1_fog'
                    },
                    'sense': {
                        name: 'èµ„æºå—…è§‰',
                        icon: 'ğŸ”',
                        type: 'positive',
                        desc: 'å‘ç°ç«æŠŠå †çš„æ¦‚ç‡+20%',
                        effect: 'torch_chance_up'
                    },
                    'heavy': {
                        name: 'æ²‰é‡æ­¥ä¼',
                        icon: 'âš“',
                        type: 'negative',
                        desc: 'æ‰€æœ‰ç§»åŠ¨æ¶ˆè€—+1ç«æŠŠ',
                        effect: 'move_cost_up'
                    },
                    'obsessive': {
                        name: 'å¼ºè¿«ç—‡',
                        icon: 'ğŸ”„',
                        type: 'negative',
                        desc: 'å¿…é¡»æ­ç¤ºå®Œæ‰€æœ‰æ ¼æ‰èƒ½æ’¤é€€',
                        effect: 'must_reveal_all'
                    },
                    'whisper': {
                        name: 'ä½è¯­ç†è§£',
                        icon: 'ğŸ‘‚',
                        type: 'easter',
                        desc: 'å¶å°”å¬åˆ°æ ¼å­çš„æç¤º',
                        effect: 'random_hints'
                    }
                };
                
                this.init();
            }
            
            // ç«æŠŠæ¶ˆè€—é…ç½®
            getTorchCost(cellType) {
                let costs = {
                    'fog': 2,      // æ™®é€šè¿·é›¾æ ¼
                    'rift': 5,     // æ·±æ¸Šè£‚éš™
                    'safe': 0,     // å·²æ­ç¤ºå®‰å…¨æ ¼ï¼ˆå…è´¹ç»è¿‡ï¼‰
                    'mine': 2,     // é›·æ ¼ï¼ˆå¦‚æœè¸©ä¸­ï¼‰
                    'polluted': 3  // æ±¡æŸ“æ ¼ï¼ˆé¢å¤–+1ï¼‰
                };
                
                // ç•¸å˜æ•ˆæœï¼šæ²‰é‡æ­¥ä¼ +1ç«æŠŠ
                if (this.mutation === 'heavy') {
                    costs['fog'] = 3;
                    costs['polluted'] = 4;
                }
                
                return costs[cellType] || 2;
            }
            
            init() {
                this.grid.clear();
                this.revealedCells.clear();
                this.edgeCells.clear();
                this.revealedCount = 0;
                this.riftCount = 0;
                this.torch = 6;  // è°ƒæ•´: 5â†’6
                this.gameOver = false;
                this.gameWon = false;
                this.marks = 0;
                this.mutation = null;
                this.coreFound = false;
                this.corePosition = null;
                this.score = 0;
                this.eyeAbilityUsed = false;
                this.fogCellsCount = 0;
                this.gameStartedAt = Date.now();
                
                document.getElementById('gameOverOverlay').classList.remove('show');
                document.getElementById('winOverlay').classList.remove('show');
                document.getElementById('mutationOverlay').classList.remove('show');
                document.getElementById('mutationInfo').style.display = 'none';
                document.getElementById('coreInfo').style.display = 'none';
                
                const centerCell = this.createCell(0, 0, 'center');
                centerCell.revealed = true;
                this.revealedCells.add('0,0');
                this.revealedCount = 1;
                
                this.updateEdgeCells();
                this.render();
                this.log('æ¸¸æˆå¼€å§‹ï¼ç«æŠŠï¼š' + this.torch + '/' + this.maxTorch, 'system');
                this.log('ç‚¹å‡»è¿·é›¾è¾¹ç¼˜æ ¼æ¶ˆè€—ç«æŠŠè¿›è¡Œæ´¾é£æ­ç¤ºã€‚', 'system');
            }
            
            createCell(x, y, type = 'fog') {
                const key = `${x},${y}`;
                const cell = {
                    x, y, key, type,
                    revealed: false,
                    number: 0,
                    polluted: false,
                    pollutionType: null,
                    hasTorch: false,
                    torchAmount: 0,
                    isEdge: false
                };
                this.grid.set(key, cell);
                
                // Day5: è·Ÿè¸ªè¿·é›¾æ ¼æ•°é‡
                if (type === 'fog') {
                    this.fogCellsCount++;
                }
                
                return cell;
            }
            
            updateEdgeCells() {
                this.edgeCells.clear();
                
                // Day5: æ£€æŸ¥æ˜¯å¦è¾¾åˆ°è¿·é›¾æ ¼ä¸Šé™
                if (this.fogCellsCount >= this.maxCells) {
                    // åªæ›´æ–°ç°æœ‰è¾¹ç¼˜æ ¼ï¼Œä¸åˆ›å»ºæ–°çš„
                    for (const key of this.revealedCells) {
                        const cell = this.grid.get(key);
                        const neighbors = this.getNeighbors(cell.x, cell.y);
                        for (const neighbor of neighbors) {
                            const nKey = `${neighbor.x},${neighbor.y}`;
                            if (this.grid.has(nKey)) {
                                const existingCell = this.grid.get(nKey);
                                if (!existingCell.revealed && existingCell.type === 'fog') {
                                    existingCell.isEdge = true;
                                    this.edgeCells.add(nKey);
                                }
                            }
                        }
                    }
                    this.updateUI();
                    return;
                }
                
                for (const key of this.revealedCells) {
                    const cell = this.grid.get(key);
                    const neighbors = this.getNeighbors(cell.x, cell.y);
                    for (const neighbor of neighbors) {
                        const nKey = `${neighbor.x},${neighbor.y}`;
                        if (!this.grid.has(nKey)) {
                            // Day5: æ£€æŸ¥ä¸Šé™
                            if (this.fogCellsCount >= this.maxCells) {
                                continue;
                            }
                            const fogCell = this.createCell(neighbor.x, neighbor.y, 'fog');
                            fogCell.isEdge = true;
                            this.edgeCells.add(nKey);
                        } else {
                            const existingCell = this.grid.get(nKey);
                            if (!existingCell.revealed && existingCell.type === 'fog') {
                                existingCell.isEdge = true;
                                this.edgeCells.add(nKey);
                            }
                        }
                    }
                }
                this.updateUI();
            }
            
            getNeighbors(x, y) {
                const neighbors = [];
                const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
                for (const [dx, dy] of dirs) {
                    neighbors.push({x: x + dx, y: y + dy});
                }
                return neighbors;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿç«æŠŠ
            canAfford(cost) {
                return this.torch >= cost;
            }
            
            // æ¶ˆè€—ç«æŠŠ
            spendTorch(amount) {
                this.torch = Math.max(0, this.torch - amount);
                this.updateUI();
                
                // ç«æŠŠè€—å°½æ£€æµ‹
                if (this.torch === 0) {
                    this.checkGameOver();
                }
            }
            
            // è·å¾—ç«æŠŠ
            gainTorch(amount) {
                const oldTorch = this.torch;
                this.torch = Math.min(this.maxTorch, this.torch + amount);
                const gained = this.torch - oldTorch;
                if (gained > 0) {
                    this.log(`è·å¾— ${gained} ä¸ªç«æŠŠï¼å½“å‰ï¼š${this.torch}/${this.maxTorch}`, 'reward');
                }
                this.updateUI();
            }
            
            // æ£€æŸ¥æ¸¸æˆç»“æŸ
            checkGameOver() {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯è¡ŒåŠ¨çš„è¾¹ç¼˜æ ¼
                let hasAffordableEdge = false;
                for (const key of this.edgeCells) {
                    const cell = this.grid.get(key);
                    if (cell) {
                        const cost = this.getTorchCost('fog');
                        if (this.torch >= cost) {
                            hasAffordableEdge = true;
                            break;
                        }
                    }
                }
                
                if (!hasAffordableEdge) {
                    this.gameOver = true;
                    document.getElementById('gameOverReason').textContent = 
                        `ç«æŠŠè€—å°½ï¼ˆ${this.torch}ï¼‰ï¼Œä¸”æ— æ³•æ­ç¤ºä»»ä½•è¾¹ç¼˜æ ¼`;
                    document.getElementById('gameOverOverlay').classList.add('show');
                    this.log('æ¸¸æˆç»“æŸï¼šç«æŠŠè€—å°½', 'event');
                }
            }
            
            revealCell(key) {
                if (this.gameOver) return false;
                
                const cell = this.grid.get(key);
                if (!cell || cell.revealed || !cell.isEdge) {
                    return false;
                }
                
                // è®¡ç®—ç«æŠŠæ¶ˆè€—
                let cost = this.getTorchCost('fog');
                if (cell.polluted) {
                    cost = this.getTorchCost('polluted');
                }
                
                // æ£€æŸ¥ç«æŠŠæ˜¯å¦è¶³å¤Ÿ
                if (!this.canAfford(cost)) {
                    this.log(`ç«æŠŠä¸è¶³ï¼éœ€è¦ ${cost} ä¸ªç«æŠŠï¼Œå½“å‰åªæœ‰ ${this.torch} ä¸ª`, 'warning');
                    return false;
                }
                
                // æ¶ˆè€—ç«æŠŠ
                this.spendTorch(cost);
                this.log(`æ¶ˆè€— ${cost} ç«æŠŠæ´¾é£æ­ç¤º (${cell.x},${cell.y})`, 'system');
                
                // å†³å®šæ ¼å­ç±»å‹
                this.determineCellType(cell);
                
                // ä¼˜åŒ–ï¼šæ·±æ¸Šè£‚éš™ç¡®è®¤å¼¹çª—
                if (cell.type === 'rift') {
                    const riftCost = 5; // æ·±æ¸Šè£‚éš™æ¶ˆè€—
                    const confirmMsg = `ã€æ·±æ¸Šè£‚éš™ã€‘\n\næ¶ˆè€— ${riftCost} ç«æŠŠæ­ç¤ºè£‚éš™\nå°†æ‰“å¼€ 3 æ¡æ–°çš„æ¢ç´¢è·¯å¾„\n\nå½“å‰ç«æŠŠï¼š${this.torch}\næ¶ˆè€—åå‰©ä½™ï¼š${this.torch - riftCost}\n\nç¡®å®šè¦æ‰“å¼€è£‚éš™å—ï¼Ÿ`;
                    
                    if (!confirm(confirmMsg)) {
                        // å–æ¶ˆæ­ç¤ºï¼Œæ¢å¤ä¸ºè¿·é›¾æ ¼
                        cell.type = 'fog';
                        cell.revealed = false;
                        this.grid.delete(key);
                        this.fogCellsCount--;
                        this.log('å–æ¶ˆæ‰“å¼€æ·±æ¸Šè£‚éš™', 'system');
                        return false;
                    }
                    
                    this.log(`ğŸ”¥ æ¶ˆè€— ${riftCost} ç«æŠŠæ‰“å¼€æ·±æ¸Šè£‚éš™ï¼`, 'event');
                }
                
                cell.revealed = true;
                this.revealedCells.add(key);
                this.revealedCount++;
                
                if (cell.type === 'rift') {
                    this.growFromRift(cell);
                    this.log(`âœ¨ è£‚éš™å¼€å¯ï¼3æ¡æ–°è·¯å¾„å·²å±•å¼€`, 'reward');
                } else if (cell.type === 'safe') {
                    this.log(`æ­ç¤ºå®‰å…¨æ ¼ï¼Œå‘¨å›´æœ‰ ${cell.number} ä¸ªé›·ã€‚`, 'system');
                    if (cell.hasTorch) {
                        this.gainTorch(cell.torchAmount);
                    }
                } else if (cell.type === 'mine') {
                    this.log(`è¸©ä¸­é›·æ ¼ï¼è§¦å‘F3å¼ºåˆ¶æ­ç¤ºã€‚`, 'event');
                    this.triggerF3(cell);
                } else if (cell.type === 'core') {
                    this.coreFound = true;
                    this.log(`ğŸ’ æ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒï¼ç°åœ¨å¯ä»¥æ’¤é€€å®Œæˆä»»åŠ¡`, 'reward');
                    document.getElementById('coreInfo').style.display = 'block';
                    document.getElementById('coreStatus').textContent = 'å·²æ‰¾åˆ°ï¼';
                    document.getElementById('coreStatus').style.color = '#27ae60';
                }
                
                this.updateEdgeCells();
                this.render();
                return true;
            }
            
            determineCellType(cell) {
                // è°ƒæ•´: æ ¸å¿ƒæ¦‚ç‡ 15%â†’20%ï¼Œä¿åº•18æ ¼
                if (this.revealedCount >= 10 && !this.coreFound && !this.corePosition) {
                    // ä¿åº•æœºåˆ¶ï¼š18æ ¼å¿…å‡ºæ ¸å¿ƒ
                    if (this.revealedCount >= this.coreGuarantee) {
                        cell.type = 'core';
                        this.corePosition = {x: cell.x, y: cell.y};
                        this.log('ğŸ’ æ·±æ¸Šæ ¸å¿ƒå‡ºç°ï¼ˆä¿åº•ï¼‰ï¼æ‰¾åˆ°å®ƒå¯ä»¥å®Œæˆä»»åŠ¡', 'reward');
                        return;
                    }
                    // æ­£å¸¸æ¦‚ç‡ï¼š20%
                    if (Math.random() < 0.20) {
                        cell.type = 'core';
                        this.corePosition = {x: cell.x, y: cell.y};
                        this.log('ğŸ’ æ·±æ¸Šæ ¸å¿ƒå‡ºç°ï¼æ‰¾åˆ°å®ƒå¯ä»¥å®Œæˆä»»åŠ¡', 'reward');
                        return;
                    }
                }
                
                if (this.revealedCount % 5 === 0 && this.revealedCount > 0) {
                    cell.type = 'rift';
                    this.riftCount++;
                    return;
                }
                
                // è°ƒæ•´: é›·ç‡ 20%â†’18%
                const rand = Math.random();
                if (rand < 0.1) {
                    cell.type = 'rift';
                    this.riftCount++;
                } else if (rand < 0.28) {  // 10%+18%=28%
                    cell.type = 'mine';
                } else {
                    cell.type = 'safe';
                    cell.number = this.countAdjacentMines(cell.x, cell.y);
                    // è°ƒæ•´: ç«æŠŠè·å–ç‡ 30%â†’35%
                    let torchChance = 0.35;  // è°ƒæ•´: 0.3â†’0.35
                    if (this.mutation === 'sense') torchChance = 0.55;  // +20%
                    if (Math.random() < torchChance) {
                        cell.hasTorch = true;
                        cell.torchAmount = Math.floor(Math.random() * 3) + 1;
                    }
                }
            }
            
            countAdjacentMines(x, y) {
                const neighbors = this.getNeighbors(x, y);
                let count = 0;
                for (const n of neighbors) {
                    const nKey = `${n.x},${n.y}`;
                    const nCell = this.grid.get(nKey);
                    if (nCell && nCell.type === 'mine') {
                        count++;
                    }
                }
                return count;
            }
            
            growFromRift(riftCell) {
                const directions = [
                    {dx: -1, dy: 0}, {dx: 1, dy: 0}, {dx: 0, dy: -1}, {dx: 0, dy: 1}
                ];
                const shuffled = directions.sort(() => Math.random() - 0.5);
                const selectedDirs = shuffled.slice(0, 3);
                
                for (const dir of selectedDirs) {
                    const newX = riftCell.x + dir.dx * 2;
                    const newY = riftCell.y + dir.dy * 2;
                    const newKey = `${newX},${newY}`;
                    
                    if (!this.grid.has(newKey)) {
                        const midX = riftCell.x + dir.dx;
                        const midY = riftCell.y + dir.dy;
                        const midKey = `${midX},${midY}`;
                        
                        if (!this.grid.has(midKey)) {
                            this.createCell(midX, midY, 'fog');
                        }
                        this.createCell(newX, newY, 'fog');
                    }
                }
            }
            
            // ä¼˜åŒ–ï¼šF3è¸©é›·æ—¶åˆ»å¼ºåŒ–
            async triggerF3(mineCell) {
                const neighbors = this.getNeighbors(mineCell.x, mineCell.y);
                let revealedCount = 0;
                
                // ä¼˜åŒ–ï¼šçªå‡ºæ˜¾ç¤ºè¸©é›·æ ¼
                this.log(`ğŸ’€ è¸©ä¸­é›·æ ¼ï¼æ·±æ¸Šä¹‹åŠ›å³å°†å¼ºåˆ¶æ­ç¤ºå‘¨å›´åŒºåŸŸ...`, 'event');
                this.highlightCell(mineCell.key, 'f3-trigger');
                
                // ä¼˜åŒ–ï¼šå»¶è¿ŸåŠ¨ç”»æ•ˆæœ
                await this.delay(300);
                
                const pollutionNames = {
                    'blur': 'ã€æ¨¡ç³Šæ±¡æŸ“ã€‘æ•°å­—Â±1è¯¯å·®ï¼ŒæŒç»­3å›åˆ',
                    'heavy': 'ã€æ²‰é‡æ±¡æŸ“ã€‘ç»è¿‡+1ç«æŠŠæ¶ˆè€—ï¼Œæ°¸ä¹…',
                    'unstable': 'ã€ä¸ç¨³å®šæ±¡æŸ“ã€‘ä¸èƒ½åœç•™ï¼Œå¿…é¡»ç¦»å¼€'
                };
                
                for (const n of neighbors) {
                    if (revealedCount >= 3) break;
                    
                    const nKey = `${n.x},${n.y}`;
                    let cell = this.grid.get(nKey);
                    
                    // ä¿®å¤ï¼šå¦‚æœæ ¼å­ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨ä½†æœªæ­ç¤ºåˆ™æ­ç¤º
                    if (!cell) {
                        cell = this.createCell(n.x, n.y, 'fog');
                        this.determineCellType(cell);
                    } else if (cell.revealed) {
                        // å·²æ­ç¤ºçš„æ ¼å­è·³è¿‡
                        continue;
                    }
                    
                    // ä¼˜åŒ–ï¼šé€ä¸ªæ­ç¤ºï¼Œå¸¦å»¶è¿Ÿ
                    await this.delay(200);
                    
                    cell.revealed = true;
                    cell.polluted = true;
                    cell.pollutionType = this.getRandomPollution();
                    this.revealedCells.add(nKey);
                    this.revealedCount++;
                    revealedCount++;
                    
                    // ä¼˜åŒ–ï¼šè¯¦ç»†æ—¥å¿—
                    let logMsg = `âš¡ F3æ­ç¤º(${n.x},${n.y})`;
                    if (cell.type === 'safe') {
                        logMsg += ` å®‰å…¨æ ¼ï¼Œå‘¨å›´${cell.number}ä¸ªé›·`;
                    } else if (cell.type === 'rift') {
                        logMsg += ` æ·±æ¸Šè£‚éš™ï¼`;
                    } else if (cell.type === 'mine') {
                        logMsg += ` åˆä¸€ä¸ªé›·ï¼`;
                    } else if (cell.type === 'core') {
                        logMsg += ` å‘ç°æ ¸å¿ƒï¼`;
                    }
                    this.log(logMsg, 'event');
                    
                    // æ±¡æŸ“è­¦å‘Š
                    this.log(`âš ï¸ è¯¥æ ¼è¢«${pollutionNames[cell.pollutionType]}`, 'warning');
                    
                    // å®æ—¶æ¸²æŸ“æ›´æ–°
                    this.render();
                    
                    if (cell.hasTorch) {
                        this.gainTorch(cell.torchAmount);
                    }
                }
                
                // ä¼˜åŒ–ï¼šF3æ€»ç»“
                await this.delay(300);
                this.log(`ğŸ“Š F3æ€»ç»“ï¼šå¼ºåˆ¶æ­ç¤º${revealedCount}æ ¼ï¼Œè·å¾—ä¿¡æ¯ä½†ä»˜å‡ºä»£ä»·`, 'system');
                
                // è·å¾—å°è®°
                this.gainMark();
            }
            
            // æ–°å¢ï¼šé«˜äº®æ ¼å­åŠ¨ç”»
            highlightCell(key, effectClass) {
                // æ¸²æŸ“åé€šè¿‡CSSç±»å®ç°é«˜äº®
                this.render();
                // å¯ä»¥æ·»åŠ é¢å¤–çš„è§†è§‰åé¦ˆ
            }
            
            // æ–°å¢ï¼šå»¶è¿Ÿå·¥å…·å‡½æ•°
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // è·å¾—å°è®°
            gainMark() {
                this.marks++;
                this.log(`è·å¾—1ä¸ªå°è®°ã€‚å½“å‰ï¼š${this.marks}/${this.maxMarks}`, 'system');
                this.updateUI();
                
                // æ£€æŸ¥æ˜¯å¦è§¦å‘ç•¸å˜
                if (this.marks >= this.maxMarks) {
                    this.triggerMutation();
                }
            }
            
            // è§¦å‘ç•¸å˜é€‰æ‹©
            triggerMutation() {
                this.log('å°è®°ç´¯ç§¯è¾¾åˆ°3ä¸ªï¼ç•¸å˜é™ä¸´...', 'event');
                
                const overlay = document.getElementById('mutationOverlay');
                const optionsContainer = document.getElementById('mutationOptions');
                optionsContainer.innerHTML = '';
                
                // éšæœºé€‰æ‹©3ç§ç•¸å˜
                const mutationKeys = Object.keys(this.mutationData);
                const shuffled = mutationKeys.sort(() => Math.random() - 0.5);
                const selected = shuffled.slice(0, 3);
                
                for (const key of selected) {
                    const data = this.mutationData[key];
                    const card = document.createElement('div');
                    card.className = `mutation-card ${data.type}`;
                    card.innerHTML = `
                        <div class="mutation-icon">${data.icon}</div>
                        <div class="mutation-name">${data.name}</div>
                        <div class="mutation-desc-text">${data.desc}</div>
                    `;
                    card.onclick = () => this.selectMutation(key);
                    optionsContainer.appendChild(card);
                }
                
                overlay.classList.add('show');
            }
            
            // é€‰æ‹©ç•¸å˜
            selectMutation(mutationKey) {
                this.mutation = mutationKey;
                const data = this.mutationData[mutationKey];
                
                document.getElementById('mutationOverlay').classList.remove('show');
                document.getElementById('mutationInfo').style.display = 'block';
                document.getElementById('mutationName').textContent = data.name;
                
                this.log(`è·å¾—ç•¸å˜ï¼š${data.name} - ${data.desc}`, 'event');
                this.updateUI();
                
                // åº”ç”¨ç•¸å˜æ•ˆæœ
                this.applyMutationEffect(mutationKey);
            }
            
            // åº”ç”¨ç•¸å˜æ•ˆæœ
            applyMutationEffect(mutationKey) {
                const effect = this.mutationData[mutationKey].effect;
                
                switch(effect) {
                    case 'torch_chance_up':
                        // ç«æŠŠå‘ç°æ¦‚ç‡+20%ï¼Œåœ¨determineCellTypeä¸­å¤„ç†
                        break;
                    case 'move_cost_up':
                        // ç§»åŠ¨æˆæœ¬+1ï¼Œåœ¨getTorchCostä¸­å¤„ç†
                        break;
                    case 'reveal_1_fog':
                        // æ·»åŠ é€è§†èƒ½åŠ›ï¼Œç‚¹å‡»è¿·é›¾æ ¼æ—¶æ£€æµ‹
                        this.enableEyeAbility();
                        break;
                }
            }
            
            // æ·±æ¸Šä¹‹çœ¼èƒ½åŠ›ï¼šé€è§†1æ ¼
            enableEyeAbility() {
                this.eyeAbilityUsed = false;
                this.log('æ·±æ¸Šä¹‹çœ¼å·²æ¿€æ´»ï¼æœ¬å›åˆå¯ä»¥é€è§†1æ ¼è¿·é›¾ã€‚', 'system');
                
                // æ·»åŠ é€è§†æŒ‰é’®æˆ–è‡ªåŠ¨æ£€æµ‹
                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç©å®¶ç‚¹å‡»è¿·é›¾æ ¼æ—¶ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œå…è´¹æ­ç¤º
            }
            
            getRandomPollution() {
                const rand = Math.random();
                if (rand < 0.4) return 'blur';
                if (rand < 0.8) return 'heavy';
                return 'unstable';
            }
            
            render() {
                const container = document.getElementById('gridContainer');
                container.innerHTML = '';
                
                let minX = 0, maxX = 0, minY = 0, maxY = 0;
                for (const cell of this.grid.values()) {
                    minX = Math.min(minX, cell.x);
                    maxX = Math.max(maxX, cell.x);
                    minY = Math.min(minY, cell.y);
                    maxY = Math.max(maxY, cell.y);
                }
                
                const width = maxX - minX + 1;
                const height = maxY - minY + 1;
                container.style.gridTemplateColumns = `repeat(${width}, 60px)`;
                
                for (let y = minY; y <= maxY; y++) {
                    for (let x = minX; x <= maxX; x++) {
                        const key = `${x},${y}`;
                        const cell = this.grid.get(key);
                        const cellDiv = document.createElement('div');
                        cellDiv.className = 'cell';
                        
                        if (!cell) {
                            cellDiv.style.visibility = 'hidden';
                        } else {
                            if (cell.type === 'center') {
                                cellDiv.classList.add('center');
                                cellDiv.textContent = 'â˜…';
                            } else if (!cell.revealed) {
                                cellDiv.classList.add('fog');
                                if (cell.isEdge) {
                                    cellDiv.classList.add('edge');
                                    // æ˜¾ç¤ºç«æŠŠæ¶ˆè€—
                                    let cost = this.getTorchCost('fog');
                                    const badge = document.createElement('span');
                                    badge.className = 'cost-badge';
                                    badge.textContent = cost;
                                    cellDiv.appendChild(badge);
                                    
                                    // æ£€æŸ¥ç«æŠŠæ˜¯å¦è¶³å¤Ÿ
                                    if (!this.canAfford(cost)) {
                                        cellDiv.classList.add('disabled');
                                    } else {
                                        cellDiv.onclick = () => this.revealCell(key);
                                    }
                                }
                            } else if (cell.type === 'safe') {
                                cellDiv.classList.add('safe');
                                cellDiv.textContent = cell.number;
                                if (cell.hasTorch) {
                                    cellDiv.textContent += 'ğŸ”¥';
                                }
                            } else if (cell.type === 'rift') {
                                cellDiv.classList.add('rift');
                                cellDiv.textContent = 'è£‚';
                            } else if (cell.type === 'mine') {
                                cellDiv.classList.add('mine');
                                cellDiv.textContent = 'ğŸ’€';
                            } else if (cell.type === 'core') {
                                cellDiv.classList.add('core');
                                cellDiv.textContent = 'ğŸ’';
                            }
                            
                            if (cell.polluted) {
                                cellDiv.classList.add('polluted');
                            }
                        }
                        
                        container.appendChild(cellDiv);
                    }
                }
            }
            
            updateUI() {
                document.getElementById('revealedCount').textContent = this.revealedCount;
                document.getElementById('edgeCount').textContent = this.edgeCells.size;
                document.getElementById('riftCount').textContent = this.riftCount;
                document.getElementById('torchCount').textContent = `${this.torch}/${this.maxTorch}`;
                document.getElementById('markCount').textContent = `${this.marks}/${this.maxMarks}`;
                
                // Day5: è¿·é›¾æ ¼ä¸Šé™æ˜¾ç¤º (è°ƒæ•´: ä¸Šé™18)
                const limitInfo = document.getElementById('limitInfo');
                if (this.fogCellsCount >= this.maxCells) {
                    limitInfo.style.display = 'block';
                    document.getElementById('limitCount').textContent = `${this.fogCellsCount}/${this.maxCells}`;
                } else {
                    limitInfo.style.display = 'none';
                }
                
                // ç«æŠŠä½æ—¶è§†è§‰è­¦å‘Š
                const torchInfo = document.getElementById('torchInfo');
                if (this.torch <= 2) {
                    torchInfo.classList.add('torch-low');
                } else {
                    torchInfo.classList.remove('torch-low');
                }
                
                // å°è®°æ¥è¿‘ä¸Šé™æ—¶è­¦å‘Š
                const markInfo = document.getElementById('markInfo');
                if (this.marks >= 2) {
                    markInfo.style.borderColor = '#e94560';
                } else {
                    markInfo.style.borderColor = '#2a2a3a';
                }
            }
            
            log(message, type = 'system') {
                const logPanel = document.getElementById('logPanel');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logPanel.appendChild(entry);
                logPanel.scrollTop = logPanel.scrollHeight;
            }
            
            restart() {
                this.init();
            }
            
            // Day4: æ’¤é€€åŠŸèƒ½ï¼ˆä¼˜åŒ–ï¼šå¼ºåŒ–å†³ç­–ï¼‰
            retreat() {
                if (this.gameOver || this.gameWon) return;
                
                // å¼ºè¿«ç—‡ç•¸å˜ï¼šå¿…é¡»æ­ç¤ºå®Œæ‰€æœ‰æ ¼
                if (this.mutation === 'obsessive') {
                    const remaining = this.edgeCells.size;
                    if (remaining > 0) {
                        this.log(`å¼ºè¿«ç—‡ç•¸å˜ï¼šè¿˜æœ‰ ${remaining} ä¸ªè¿·é›¾æ ¼æœªæ­ç¤ºï¼Œä¸èƒ½æ’¤é€€ï¼`, 'warning');
                        return;
                    }
                }
                
                // ä¼˜åŒ–ï¼šè®¡ç®—é¢„æœŸå¾—åˆ†
                const expectedScore = this.calculateExpectedScore();
                const remainingCells = this.edgeCells.size;
                
                // ä¼˜åŒ–ï¼šæ„å»ºç¡®è®¤ä¿¡æ¯
                let confirmMsg = `ã€æ’¤é€€ç¡®è®¤ã€‘\n\n`;
                confirmMsg += `å·²æ­ç¤º: ${this.revealedCount} æ ¼\n`;
                confirmMsg += `å‰©ä½™ç«æŠŠ: ${this.torch}\n`;
                confirmMsg += `æœªæ¢ç´¢: ${remainingCells} æ ¼\n\n`;
                
                if (this.coreFound) {
                    confirmMsg += `âœ… å·²æ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒï¼\n`;
                    confirmMsg += `é¢„æœŸå¾—åˆ†: ${expectedScore} åˆ†\n\n`;
                    confirmMsg += `ç¡®å®šè¦æ’¤é€€å—ï¼Ÿ`;
                } else {
                    confirmMsg += `âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒï¼\n`;
                    confirmMsg += `é¢„æœŸå¾—åˆ†: ${expectedScore} åˆ† (åŸºç¡€åˆ†ï¼Œæ— æ ¸å¿ƒå¥–åŠ±)\n\n`;
                    confirmMsg += `å»ºè®®ç»§ç»­æ¢ç´¢å¯»æ‰¾æ ¸å¿ƒï¼ˆ+500åˆ†ï¼‰\n`;
                    confirmMsg += `ç¡®å®šè¦ç°åœ¨æ’¤é€€å—ï¼Ÿ`;
                }
                
                if (!confirm(confirmMsg)) {
                    this.log('å–æ¶ˆæ’¤é€€ï¼Œç»§ç»­æ¢ç´¢', 'system');
                    return;
                }
                
                // è®¡ç®—æœ€ç»ˆå¾—åˆ†
                this.calculateScore();
                
                if (this.coreFound) {
                    // èƒœåˆ©
                    this.gameWon = true;
                    document.getElementById('winOverlay').classList.add('show');
                    document.getElementById('winReason').textContent = 'æˆåŠŸæ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒå¹¶æ’¤é€€ï¼';
                    this.log('ğŸ‰ ä»»åŠ¡å®Œæˆï¼è·å¾—æ·±æ¸Šæ ¸å¿ƒå¹¶æˆåŠŸæ’¤é€€', 'reward');
                } else {
                    // æ’¤é€€ä½†æœªæ‰¾åˆ°æ ¸å¿ƒ
                    this.gameWon = true;
                    document.getElementById('winOverlay').classList.add('show');
                    document.getElementById('winReason').textContent = 'æ’¤é€€äº†ï¼Œä½†æœªæ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒ...';
                    document.getElementById('winTitle').textContent = 'ä»»åŠ¡ç»“æŸ';
                    this.log('ä»»åŠ¡ç»“æŸï¼šæ’¤é€€æ—¶æœªæ‰¾åˆ°æ·±æ¸Šæ ¸å¿ƒ', 'warning');
                }
            }
            
            // æ–°å¢ï¼šè®¡ç®—é¢„æœŸå¾—åˆ†ï¼ˆç”¨äºæ’¤é€€ç¡®è®¤ï¼‰
            calculateExpectedScore() {
                let score = 0;
                
                // åŸºç¡€åˆ†ï¼šæ­ç¤ºæ ¼æ•° Ã— 10
                score += this.revealedCount * 10;
                
                // æ ¸å¿ƒå¥–åŠ±
                if (this.coreFound) {
                    score += 500;
                }
                
                // ç«æŠŠå‰©ä½™å¥–åŠ±
                score += this.torch * 20;
                
                // æ·±æ¸Šè£‚éš™å¥–åŠ±
                score += this.riftCount * 50;
                
                // ç•¸å˜æƒ©ç½š/å¥–åŠ±
                if (this.mutation) {
                    const data = this.mutationData[this.mutation];
                    if (data.type === 'positive') score += 100;
                    else if (data.type === 'negative') score -= 50;
                    else if (data.type === 'easter') score += 200;
                }
                
                return score;
            }
            
            // è®¡ç®—å¾—åˆ†
            calculateScore() {
                let score = 0;
                let breakdown = [];
                
                // åŸºç¡€åˆ†ï¼šæ­ç¤ºæ ¼æ•° Ã— 10
                const revealScore = this.revealedCount * 10;
                score += revealScore;
                breakdown.push(`æ­ç¤ºæ ¼æ•°: ${this.revealedCount} Ã— 10 = ${revealScore}`);
                
                // æ ¸å¿ƒå¥–åŠ±
                if (this.coreFound) {
                    score += 500;
                    breakdown.push('æ‰¾åˆ°æ ¸å¿ƒ: +500');
                }
                
                // ç«æŠŠå‰©ä½™å¥–åŠ±
                const torchScore = this.torch * 20;
                score += torchScore;
                breakdown.push(`å‰©ä½™ç«æŠŠ: ${this.torch} Ã— 20 = ${torchScore}`);
                
                // æ·±æ¸Šè£‚éš™å¥–åŠ±
                const riftScore = this.riftCount * 50;
                score += riftScore;
                breakdown.push(`å‘ç°è£‚éš™: ${this.riftCount} Ã— 50 = ${riftScore}`);
                
                // ç•¸å˜æƒ©ç½š/å¥–åŠ±
                if (this.mutation) {
                    const data = this.mutationData[this.mutation];
                    if (data.type === 'positive') {
                        score += 100;
                        breakdown.push(`æ­£å‘ç•¸å˜: +100`);
                    } else if (data.type === 'negative') {
                        score -= 50;
                        breakdown.push(`è´Ÿå‘ç•¸å˜: -50`);
                    } else if (data.type === 'easter') {
                        score += 200;
                        breakdown.push(`å½©è›‹ç•¸å˜: +200`);
                    }
                }
                
                this.score = score;
                document.getElementById('scoreDisplay').textContent = `å¾—åˆ†: ${score}`;
                document.getElementById('scoreBreakdown').innerHTML = breakdown.join('<br>');
            }
            
            autoReveal() {
                if (this.gameOver) return;
                const edges = Array.from(this.edgeCells);
                if (edges.length === 0) return;
                
                // æ‰¾åˆ°ç«æŠŠè¶³å¤Ÿçš„è¾¹ç¼˜æ ¼
                const affordableEdges = edges.filter(key => {
                    const cell = this.grid.get(key);
                    if (!cell) return false;
                    const cost = this.getTorchCost('fog');
                    return this.torch >= cost;
                });
                
                if (affordableEdges.length === 0) {
                    this.log('ç«æŠŠä¸è¶³ï¼Œæ— æ³•è‡ªåŠ¨æ­ç¤º', 'warning');
                    return;
                }
                
                const randomEdge = affordableEdges[Math.floor(Math.random() * affordableEdges.length)];
                this.revealCell(randomEdge);
            }
        }
        
        const game = new MistGridGame();
    </script>
    <!-- DebugPanel é”™è¯¯è°ƒè¯•é¢æ¿ -->
    <script src="js/debug-panel.js"></script>
</body>
</html>
